<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manufacturer Portal - Peekaboo Shades</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    /* Header */
    .mfr-header {
      background: #1a1a2e;
      color: white;
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
    .mfr-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .mfr-header img {
      height: 32px;
    }
    .mfr-header h1 {
      font-size: 18px;
      font-weight: 600;
    }
    .mfr-header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .mfr-user {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .mfr-user-avatar {
      width: 32px;
      height: 32px;
      background: #16213e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    .btn-logout {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-logout:hover {
      background: rgba(255,255,255,0.1);
    }

    /* Main Content */
    .mfr-main {
      margin-top: 64px;
      padding: 24px;
      max-width: 1400px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    @media (max-width: 1200px) {
      .stats-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 768px) {
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .stat-card.pending { border-left: 4px solid #f59e0b; }
    .stat-card.production { border-left: 4px solid #3b82f6; }
    .stat-card.qa { border-left: 4px solid #8b5cf6; }
    .stat-card.shipped { border-left: 4px solid #10b981; }
    .stat-card.total { border-left: 4px solid #1a1a2e; }
    .stat-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a2e;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .tab-btn {
      padding: 12px 24px;
      background: none;
      border: none;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: #1a1a2e; }
    .tab-btn.active {
      color: #1a1a2e;
      border-bottom-color: #1a1a2e;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Orders Section */
    .orders-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .orders-title {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a2e;
    }
    .orders-filters {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .filter-select, .filter-input {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    .btn-refresh {
      padding: 8px 16px;
      background: #1a1a2e;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Orders Table */
    .orders-table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .orders-table {
      width: 100%;
      border-collapse: collapse;
    }
    .orders-table th {
      text-align: left;
      padding: 14px 16px;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }
    .orders-table td {
      padding: 16px;
      font-size: 14px;
      color: #1a1a2e;
      border-bottom: 1px solid #f3f4f6;
    }
    .orders-table tr:hover {
      background: #f9fafb;
    }
    .orders-table tr:last-child td {
      border-bottom: none;
    }
    .order-number {
      font-weight: 600;
      color: #3b82f6;
      cursor: pointer;
    }
    .order-number:hover {
      text-decoration: underline;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-badge.order_received { background: #fef3c7; color: #92400e; }
    .status-badge.manufacturing { background: #dbeafe; color: #1e40af; }
    .status-badge.qa { background: #ede9fe; color: #5b21b6; }
    .status-badge.shipped { background: #d1fae5; color: #065f46; }
    .btn-action {
      padding: 6px 12px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-action:hover {
      background: #f3f4f6;
    }
    .btn-action.primary {
      background: #1a1a2e;
      color: white;
      border-color: #1a1a2e;
    }
    .btn-action.primary:hover {
      background: #16213e;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.show {
      display: flex;
    }
    .modal {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* Order Detail */
    .order-detail-section {
      margin-bottom: 24px;
    }
    .order-detail-section h3 {
      font-size: 14px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    .order-info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .order-info-item {
      background: #f9fafb;
      padding: 12px;
      border-radius: 8px;
    }
    .order-info-label {
      font-size: 11px;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .order-info-value {
      font-size: 14px;
      font-weight: 500;
      color: #1a1a2e;
    }
    .items-table {
      width: 100%;
      border-collapse: collapse;
      background: #f9fafb;
      border-radius: 8px;
      overflow: hidden;
    }
    .items-table th {
      text-align: left;
      padding: 12px;
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      background: #f3f4f6;
    }
    .items-table td {
      padding: 12px;
      font-size: 13px;
      border-top: 1px solid #e5e7eb;
    }
    .status-timeline {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .timeline-item {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    .timeline-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e5e7eb;
      margin-top: 4px;
    }
    .timeline-dot.completed { background: #10b981; }
    .timeline-dot.current { background: #3b82f6; }
    .timeline-content {
      flex: 1;
    }
    .timeline-status {
      font-weight: 500;
      font-size: 14px;
    }
    .timeline-date {
      font-size: 12px;
      color: #6b7280;
    }

    /* Status Actions */
    .status-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn-status {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-status.start-production {
      background: #3b82f6;
      color: white;
    }
    .btn-status.start-qa {
      background: #8b5cf6;
      color: white;
    }
    .btn-status.mark-shipped {
      background: #10b981;
      color: white;
    }
    .btn-status:disabled {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
    }

    /* Tracking Form */
    .tracking-form {
      background: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }
    .tracking-form h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .tracking-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .tracking-grid .form-group {
      margin-bottom: 0;
    }
    .form-group label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #6b7280;
      margin-bottom: 6px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1a1a2e;
      color: white;
      padding: 14px 20px;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 2000;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      padding: 40px;
    }
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e5e7eb;
      border-top-color: #1a1a2e;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="mfr-header">
    <div class="mfr-header-left">
      <img src="/images/logo.png" alt="Logo" onerror="this.style.display='none'">
      <h1>Manufacturer Portal</h1>
    </div>
    <div class="mfr-header-right">
      <div class="mfr-user">
        <div class="mfr-user-avatar" id="user-avatar">F</div>
        <span id="user-name">Factory Manager</span>
      </div>
      <button class="btn-logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="mfr-main">
    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card pending">
        <div class="stat-label">Pending</div>
        <div class="stat-value" id="stat-pending">-</div>
      </div>
      <div class="stat-card production">
        <div class="stat-label">In Production</div>
        <div class="stat-value" id="stat-production">-</div>
      </div>
      <div class="stat-card qa">
        <div class="stat-label">In QA</div>
        <div class="stat-value" id="stat-qa">-</div>
      </div>
      <div class="stat-card shipped">
        <div class="stat-label">Shipped</div>
        <div class="stat-value" id="stat-shipped">-</div>
      </div>
      <div class="stat-card total">
        <div class="stat-label">Active Orders</div>
        <div class="stat-value" id="stat-total">-</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="all">All Orders</button>
      <button class="tab-btn" data-tab="order_received">Pending</button>
      <button class="tab-btn" data-tab="manufacturing">In Production</button>
      <button class="tab-btn" data-tab="qa">Quality Check</button>
      <button class="tab-btn" data-tab="shipped">Shipped</button>
    </div>

    <!-- Orders Section -->
    <div class="tab-content active" id="tab-all">
      <div class="orders-header">
        <h2 class="orders-title">Orders</h2>
        <div class="orders-filters">
          <input type="text" class="filter-input" id="filter-search" placeholder="Search order #...">
          <button class="btn-refresh" onclick="loadOrders()">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Refresh
          </button>
        </div>
      </div>

      <div class="orders-table-container">
        <table class="orders-table">
          <thead>
            <tr>
              <th>Order #</th>
              <th>Customer</th>
              <th>Items</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="orders-tbody">
            <tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Order Detail Modal -->
  <div class="modal-overlay" id="order-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Order <span id="modal-order-number"></span></h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-body">
        <div class="loading"><div class="spinner"></div></div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <div style="display: flex; gap: 8px;">
          <button class="btn-action" onclick="downloadOrderExcel()" style="background: #10b981; color: white; border-color: #10b981;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: middle;">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Excel
          </button>
          <button class="btn-action" onclick="downloadOrderPDF()" style="background: #ef4444; color: white; border-color: #ef4444;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px; vertical-align: middle;">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            PDF
          </button>
        </div>
        <button class="btn-action" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // Auth check
    const token = localStorage.getItem('mfrToken');
    const user = JSON.parse(localStorage.getItem('mfrUser') || '{}');

    if (!token) {
      window.location.href = '/manufacturer/login.html';
    }

    // Set user info
    document.getElementById('user-name').textContent = user.name || 'User';
    document.getElementById('user-avatar').textContent = (user.name || 'U')[0].toUpperCase();

    // Current filter
    let currentStatus = null;
    let orders = [];
    let currentOrderDetail = null; // Store current order for download functions

    // API helper
    async function api(endpoint, options = {}) {
      try {
        const response = await fetch(endpoint, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            ...options.headers
          }
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
      } catch (error) {
        console.error('API Error:', endpoint, error);
        return { success: false, error: error.message };
      }
    }

    // Load stats
    async function loadStats() {
      try {
        const result = await api('/api/manufacturer/stats');
        if (result.success) {
          const data = result.data;
          document.getElementById('stat-pending').textContent = data.pending || 0;
          document.getElementById('stat-production').textContent = data.inProduction || 0;
          document.getElementById('stat-qa').textContent = data.inQA || 0;
          document.getElementById('stat-shipped').textContent = data.shipped || 0;
          document.getElementById('stat-total').textContent = data.totalActive || 0;
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    // Load orders
    async function loadOrders() {
      console.log('loadOrders: Starting...');
      const tbody = document.getElementById('orders-tbody');
      tbody.innerHTML = '<tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr>';

      try {
        let url = '/api/manufacturer/orders';
        if (currentStatus) {
          url += `?status=${currentStatus}`;
        }
        console.log('loadOrders: Fetching from', url);

        const result = await api(url);
        console.log('loadOrders: API response', result);

        if (result.success) {
          orders = result.data || [];
          console.log('loadOrders: Got', orders.length, 'orders');
          renderOrders();
        } else {
          console.error('loadOrders: API returned error', result.error);
          tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><p>Failed to load orders: ' + (result.error || 'Unknown error') + '</p></div></td></tr>';
        }
      } catch (error) {
        console.error('loadOrders: Exception', error);
        tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><p>Error loading orders: ' + error.message + '</p></div></td></tr>';
      }
    }

    // Render orders
    function renderOrders() {
      const tbody = document.getElementById('orders-tbody');
      const search = document.getElementById('filter-search').value.toLowerCase();

      let filtered = orders;
      if (search) {
        filtered = orders.filter(o => o.orderNumber.toLowerCase().includes(search));
      }

      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                </svg>
                <p>No orders found</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filtered.map(order => `
        <tr>
          <td>
            <span class="order-number" onclick="openOrderDetail('${order.id}')">${order.orderNumber}</span>
          </td>
          <td>${escapeHtml(order.customer || 'N/A')}</td>
          <td>${order.itemCount} item${order.itemCount !== 1 ? 's' : ''}</td>
          <td><span class="status-badge ${order.status}">${formatStatus(order.status)}</span></td>
          <td>${formatDate(order.createdAt)}</td>
          <td>
            <button class="btn-action primary" onclick="openOrderDetail('${order.id}')">View</button>
          </td>
        </tr>
      `).join('');
    }

    // Open order detail modal
    async function openOrderDetail(orderId) {
      console.log('openOrderDetail: Loading order', orderId);
      document.getElementById('order-modal').classList.add('show');
      document.getElementById('modal-body').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      try {
        const result = await api(`/api/manufacturer/orders/${orderId}`);
        console.log('openOrderDetail: API response', result);

        if (result.success) {
          const order = result.data;
          currentOrderDetail = order; // Store for download functions
          document.getElementById('modal-order-number').textContent = order.orderNumber;
          renderOrderDetail(order);
        } else {
          console.error('openOrderDetail: API returned error', result.error);
          document.getElementById('modal-body').innerHTML = `
            <div class="empty-state">
              <p style="color: #ef4444; font-weight: 600;">Failed to load order details</p>
              <p style="color: #6b7280; font-size: 14px;">${result.error || 'Unknown error'}</p>
              <button class="btn-action" onclick="closeModal()" style="margin-top: 16px;">Close</button>
            </div>
          `;
        }
      } catch (error) {
        console.error('openOrderDetail: Exception', error);
        document.getElementById('modal-body').innerHTML = `
          <div class="empty-state">
            <p style="color: #ef4444; font-weight: 600;">Error loading order</p>
            <p style="color: #6b7280; font-size: 14px;">${error.message}</p>
            <button class="btn-action" onclick="closeModal()" style="margin-top: 16px;">Close</button>
          </div>
        `;
      }
    }

    // Render order detail
    function renderOrderDetail(order) {
      const body = document.getElementById('modal-body');

      const statusActions = getStatusActions(order.status);

      body.innerHTML = `
        <div class="order-detail-section">
          <h3>Order Information</h3>
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #1a1a2e; margin-bottom: 20px;">
            <thead>
              <tr style="background: #1a1a2e; color: white;">
                <th style="padding: 10px; text-align: left; border: 1px solid #374151; width: 30%;">FIELD</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #374151;">VALUE</th>
              </tr>
            </thead>
            <tbody>
              <tr><td style="padding: 8px 10px; border: 1px solid #ddd; font-weight: 600; background: #f9fafb;">Order Number</td><td style="padding: 8px 10px; border: 1px solid #ddd; font-weight: 700; color: #3b82f6;">${order.orderNumber}</td></tr>
              <tr><td style="padding: 8px 10px; border: 1px solid #ddd; font-weight: 600; background: #f9fafb;">Status</td><td style="padding: 8px 10px; border: 1px solid #ddd;"><span class="status-badge ${order.status}">${formatStatus(order.status)}</span></td></tr>
              <tr><td style="padding: 8px 10px; border: 1px solid #ddd; font-weight: 600; background: #f9fafb;">Order Date</td><td style="padding: 8px 10px; border: 1px solid #ddd;">${formatDate(order.createdAt)}</td></tr>
            </tbody>
          </table>

          <h3>Customer Details</h3>
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #1a1a2e; margin-bottom: 20px;">
            <thead>
              <tr style="background: #1a1a2e; color: white;">
                <th style="padding: 10px; text-align: left; border: 1px solid #374151; width: 30%;">FIELD</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #374151;">VALUE</th>
              </tr>
            </thead>
            <tbody>
              <tr><td style="padding: 8px 10px; border: 1px solid #ddd; font-weight: 600; background: #f9fafb;">Name</td><td style="padding: 8px 10px; border: 1px solid #ddd;">${escapeHtml(order.customer?.name || order.customer_name || 'N/A')}</td></tr>
              <tr><td style="padding: 8px 10px; border: 1px solid #ddd; font-weight: 600; background: #f9fafb;">Email</td><td style="padding: 8px 10px; border: 1px solid #ddd;">${escapeHtml(order.customer?.email || order.customer_email || 'N/A')}</td></tr>
              <tr><td style="padding: 8px 10px; border: 1px solid #ddd; font-weight: 600; background: #f9fafb;">Phone</td><td style="padding: 8px 10px; border: 1px solid #ddd;">${escapeHtml(order.customer?.phone || order.customer_phone || 'N/A')}</td></tr>
              <tr><td style="padding: 8px 10px; border: 1px solid #ddd; font-weight: 600; background: #f9fafb;">Shipping Address</td><td style="padding: 8px 10px; border: 1px solid #ddd;">${formatAddress(order.customer?.address || order.shipping_address)}</td></tr>
            </tbody>
          </table>

          ${order.manufacturerInvoice ? `
          <h3>Invoice Information</h3>
          <table style="width: 100%; border-collapse: collapse; border: 2px solid #92400e; margin-bottom: 20px; background: #fef3c7;">
            <thead>
              <tr style="background: #92400e; color: white;">
                <th style="padding: 10px; text-align: left; border: 1px solid #92400e; width: 30%;">FIELD</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #92400e;">VALUE</th>
              </tr>
            </thead>
            <tbody>
              <tr><td style="padding: 8px 10px; border: 1px solid #f59e0b; font-weight: 600;">Invoice Number</td><td style="padding: 8px 10px; border: 1px solid #f59e0b; font-weight: 700; color: #92400e;">${order.manufacturerInvoice.invoiceNumber}</td></tr>
              <tr><td style="padding: 8px 10px; border: 1px solid #f59e0b; font-weight: 600;">Status</td><td style="padding: 8px 10px; border: 1px solid #f59e0b;">${order.manufacturerInvoice.status || 'pending'}</td></tr>
              <tr><td style="padding: 8px 10px; border: 1px solid #f59e0b; font-weight: 600;">Total</td><td style="padding: 8px 10px; border: 1px solid #f59e0b; font-weight: 700;">$${(order.manufacturerInvoice.total || 0).toFixed(2)}</td></tr>
            </tbody>
          </table>
          ` : ''}
        </div>

        <div class="order-detail-section">
          <h3>Items to Manufacture (${order.items.length} items, ${order.items.reduce((sum, i) => sum + i.quantity, 0)} total units)</h3>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; background: white; border: 2px solid #1a1a2e; min-width: 1700px;">
              <thead>
                <tr style="background: #1a1a2e; color: white;">
                  <th style="padding: 8px 5px; text-align: center; font-size: 10px; font-weight: 600; border: 1px solid #374151;">#</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">ROOM</th>
                  <th style="padding: 8px 5px; text-align: center; font-size: 10px; font-weight: 600; border: 1px solid #374151;">QTY</th>
                  <th style="padding: 8px 5px; text-align: center; font-size: 10px; font-weight: 600; border: 1px solid #374151;">W x H</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">FABRIC</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">LIGHT FILTER</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">CASSETTE</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">BOTTOM BAR</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">ROLL TYPE</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">MOUNT</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">CHAIN SIDE</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">CONTROL</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">MOTOR BRAND</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">MOTOR TYPE</th>
                  <th style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #374151;">REMOTE</th>
                  <th style="padding: 8px 5px; text-align: center; font-size: 10px; font-weight: 600; border: 1px solid #374151;">SOLAR</th>
                  <th style="padding: 8px 5px; text-align: center; font-size: 10px; font-weight: 600; border: 1px solid #374151;">SMART HUB</th>
                  <th style="padding: 8px 5px; text-align: center; font-size: 10px; font-weight: 600; border: 1px solid #374151;">USB</th>
                  <th style="padding: 8px 5px; text-align: right; font-size: 10px; font-weight: 600; border: 1px solid #374151; background: #065f46;">UNIT COST</th>
                  <th style="padding: 8px 5px; text-align: right; font-size: 10px; font-weight: 600; border: 1px solid #374151; background: #065f46;">LINE COST</th>
                </tr>
              </thead>
              <tbody>
                ${order.items.map((item, idx) => {
                  const cfg = parseConfig(item.configuration || item.options);
                  const pb = item.price_breakdown || {};

                  // Get price snapshot data (check both singular and plural property names)
                  const priceSnapshot = item.price_snapshot || item.price_snapshots || {};
                  const mfrPrice = priceSnapshot.manufacturer_price || {};
                  const customerPrice = priceSnapshot.customer_price || {};
                  const optionsBreakdown = customerPrice.options_breakdown || [];
                  const accessoriesBreakdown = customerPrice.accessories_breakdown || [];

                  // Calculate manufacturer cost from price snapshot when available
                  const widthM = item.width * 0.0254;
                  const heightM = item.height * 0.0254;
                  const areaSqM = Math.max(widthM * heightM, 1.2);

                  // Helper to get manufacturer cost from breakdown
                  const getOptionMfrCost = (type) => {
                    const opt = optionsBreakdown.find(o => o.type === type);
                    return opt ? opt.manufacturerCost : null;
                  };
                  const getAccessoryMfrCost = (code) => {
                    const acc = accessoriesBreakdown.find(a => a.code === code);
                    return acc ? acc.manufacturerCost : null;
                  };

                  const baseFabricCost = mfrPrice.unit_cost || mfrPrice.total_cost || mfrPrice.cost || (pb.dimensionAdjustedPrice || pb.basePrice || 40) * 0.5;
                  const motorBrand = cfg.motorBrand || cfg.chainType || '';
                  const motorMfrCosts = { 'motorized-app': 45, 'aok': 45, 'motorized-remote': 47, 'dooya': 47, 'plugin-motor': 55 };
                  const motorCost = getOptionMfrCost('motorization') ?? (cfg.controlType === 'motorized' ? (motorMfrCosts[motorBrand] || 45) : 0);
                  const remoteMfrCosts = { '1-channel': 4.40, '6-channel': 6.60, '15-channel': 11.35, '16-channel': 11.35 };
                  const remoteCost = getOptionMfrCost('remote') ?? (cfg.remoteType ? (remoteMfrCosts[cfg.remoteType] || 0) : 0);
                  const solarCost = getOptionMfrCost('solar') ?? ((cfg.solarType === 'yes' && cfg.controlType === 'motorized') ? 20.5 : 0);
                  const smartHubCost = getAccessoryMfrCost('smart-hub') ?? ((parseInt(cfg.smartHubQty) || 0) * 23.50);
                  const usbChargerCost = getAccessoryMfrCost('usb-charger') ?? ((parseInt(cfg.usbChargerQty) || 0) * 5);
                  const fabricCassettes = ['fabric-wrapped-v3', 'fabric-inserted-s1', 'curve-white-s2', 'fabric-wrapped-s3'];
                  const cassetteCost = getOptionMfrCost('valance_type') ?? (fabricCassettes.includes(cfg.standardCassette) ? (2.20 * areaSqM * 0.5) : 0);
                  const fabricBars = ['type-c-fabric-wrapped', 'type-b', 'simple-rolling', 'type-d'];
                  const barCost = getOptionMfrCost('bottom_rail') ?? (fabricBars.includes(cfg.standardBottomBar) ? (2.20 * areaSqM * 0.5) : 0);

                  const mfrCost = baseFabricCost + motorCost + remoteCost + solarCost + smartHubCost + usbChargerCost + cassetteCost + barCost;
                  const lineCost = mfrCost * item.quantity;
                  return `
                <tr style="${idx % 2 === 0 ? 'background: #ffffff;' : 'background: #f9fafb;'}">
                  <td style="padding: 8px 5px; text-align: center; font-size: 11px; font-weight: 700; border: 1px solid #d1d5db;">${idx + 1}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #d1d5db; color: #3b82f6;">${escapeHtml(item.room_label || item.roomLabel || '-')}</td>
                  <td style="padding: 8px 5px; text-align: center; font-size: 12px; font-weight: 700; border: 1px solid #d1d5db; background: #fef3c7;">${item.quantity}</td>
                  <td style="padding: 8px 5px; text-align: center; font-size: 10px; font-weight: 600; border: 1px solid #d1d5db;">${item.width}" x ${item.height}"</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 600; border: 1px solid #d1d5db; color: #1a1a2e;">${cfg.fabricCode || '-'}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db;">${cfg.lightFiltering || '-'}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db;">${cfg.standardCassette || '-'}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db;">${cfg.standardBottomBar || '-'}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db;">${cfg.rollerType || '-'}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db;">${cfg.mountType || '-'}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db;">${cfg.chainSide || '-'}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db;">${cfg.controlType || '-'}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db;">${cfg.motorBrand || cfg.chainType || '-'}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db;">${cfg.motorType || '-'}</td>
                  <td style="padding: 8px 5px; text-align: left; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db;">${cfg.remoteType || '-'}</td>
                  <td style="padding: 8px 5px; text-align: center; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db; ${cfg.solarType === 'yes' ? 'background: #d1fae5; color: #065f46; font-weight: 600;' : ''}">${cfg.solarType === 'yes' ? 'YES' : '-'}</td>
                  <td style="padding: 8px 5px; text-align: center; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db; ${(cfg.smartHubQty > 0 || cfg.smartHub === 'yes') ? 'background: #dbeafe; color: #1e40af; font-weight: 600;' : ''}">${cfg.smartHubQty > 0 ? cfg.smartHubQty : (cfg.smartHub === 'yes' ? 'YES' : '-')}</td>
                  <td style="padding: 8px 5px; text-align: center; font-size: 10px; font-weight: 500; border: 1px solid #d1d5db; ${(cfg.usbChargerQty > 0 || cfg.usbCharger === 'yes') ? 'background: #fef3c7; color: #92400e; font-weight: 600;' : ''}">${cfg.usbChargerQty > 0 ? cfg.usbChargerQty : (cfg.usbCharger === 'yes' ? 'YES' : '-')}</td>
                  <td style="padding: 8px 5px; text-align: right; font-size: 11px; font-weight: 700; border: 1px solid #d1d5db; background: #d1fae5; color: #065f46;">$${mfrCost.toFixed(2)}</td>
                  <td style="padding: 8px 5px; text-align: right; font-size: 11px; font-weight: 700; border: 1px solid #d1d5db; background: #a7f3d0; color: #065f46;">$${lineCost.toFixed(2)}</td>
                </tr>
                `;}).join('')}
                <tr style="background: #1a1a2e; color: white;">
                  <td colspan="18" style="padding: 10px; text-align: right; font-size: 12px; font-weight: 700; border: 1px solid #374151;">TOTAL MANUFACTURER COST:</td>
                  <td colspan="2" style="padding: 10px; text-align: right; font-size: 14px; font-weight: 700; border: 1px solid #374151; background: #065f46;">$${(order.pricing?.manufacturerCost || order.items.reduce((sum, i) => {
                    const cfg = parseConfig(i.configuration || i.options);
                    const pb = i.price_breakdown || {};
                    // Get price snapshot data (check both singular and plural property names)
                    const priceSnapshot = i.price_snapshot || i.price_snapshots || {};
                    const mfrPrice = priceSnapshot.manufacturer_price || {};
                    const customerPrice = priceSnapshot.customer_price || {};
                    const optionsBreakdown = customerPrice.options_breakdown || [];
                    const accessoriesBreakdown = customerPrice.accessories_breakdown || [];
                    // Helper functions
                    const getOptionMfrCost = (type) => {
                      const opt = optionsBreakdown.find(o => o.type === type);
                      return opt ? opt.manufacturerCost : null;
                    };
                    const getAccessoryMfrCost = (code) => {
                      const acc = accessoriesBreakdown.find(a => a.code === code);
                      return acc ? acc.manufacturerCost : null;
                    };
                    const widthM = i.width * 0.0254;
                    const heightM = i.height * 0.0254;
                    const areaSqM = Math.max(widthM * heightM, 1.2);
                    const baseFabricCost = mfrPrice.unit_cost || mfrPrice.total_cost || mfrPrice.cost || (pb.dimensionAdjustedPrice || pb.basePrice || 40) * 0.5;
                    const motorBrand = cfg.motorBrand || cfg.chainType || '';
                    const motorMfrCosts = { 'motorized-app': 45, 'aok': 45, 'motorized-remote': 47, 'dooya': 47, 'plugin-motor': 55 };
                    const motorCost = getOptionMfrCost('motorization') ?? (cfg.controlType === 'motorized' ? (motorMfrCosts[motorBrand] || 45) : 0);
                    const remoteMfrCosts = { '1-channel': 4.40, '6-channel': 6.60, '15-channel': 11.35, '16-channel': 11.35 };
                    const remoteCost = getOptionMfrCost('remote') ?? (cfg.remoteType ? (remoteMfrCosts[cfg.remoteType] || 0) : 0);
                    const solarCost = getOptionMfrCost('solar') ?? ((cfg.solarType === 'yes' && cfg.controlType === 'motorized') ? 20.5 : 0);
                    const smartHubCost = getAccessoryMfrCost('smart-hub') ?? ((parseInt(cfg.smartHubQty) || 0) * 23.50);
                    const usbChargerCost = getAccessoryMfrCost('usb-charger') ?? ((parseInt(cfg.usbChargerQty) || 0) * 5);
                    const fabricCassettes = ['fabric-wrapped-v3', 'fabric-inserted-s1', 'curve-white-s2', 'fabric-wrapped-s3'];
                    const cassetteCost = getOptionMfrCost('valance_type') ?? (fabricCassettes.includes(cfg.standardCassette) ? (2.20 * areaSqM * 0.5) : 0);
                    const fabricBars = ['type-c-fabric-wrapped', 'type-b', 'simple-rolling', 'type-d'];
                    const barCost = getOptionMfrCost('bottom_rail') ?? (fabricBars.includes(cfg.standardBottomBar) ? (2.20 * areaSqM * 0.5) : 0);
                    const itemMfrCost = baseFabricCost + motorCost + remoteCost + solarCost + smartHubCost + usbChargerCost + cassetteCost + barCost;
                    return sum + (itemMfrCost * i.quantity);
                  }, 0)).toFixed(2)}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Detailed Price Breakdown Per Item -->
          <div style="margin-top: 32px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
            <div style="width: 4px; height: 28px; background: linear-gradient(180deg, #065f46 0%, #10b981 100%); border-radius: 2px;"></div>
            <div>
              <h4 style="margin: 0; font-size: 18px; font-weight: 700; color: #1a1a2e;">Detailed Price Breakdown</h4>
              <p style="margin: 2px 0 0 0; font-size: 12px; color: #6b7280;">Manufacturing cost breakdown per item</p>
            </div>
          </div>
          ${order.items.map((item, idx) => {
            const cfg = parseConfig(item.configuration || item.options);
            const pb = item.price_breakdown || {};

            // Get price snapshot data (check both singular and plural property names)
            const priceSnapshot = item.price_snapshot || item.price_snapshots || {};
            const mfrPrice = priceSnapshot.manufacturer_price || {};
            const customerPrice = priceSnapshot.customer_price || {};
            const optionsBreakdown = customerPrice.options_breakdown || [];
            const accessoriesBreakdown = customerPrice.accessories_breakdown || [];

            // Calculate individual option costs based on configuration
            const widthM = item.width * 0.0254;
            const heightM = item.height * 0.0254;
            const areaSqM = Math.max(widthM * heightM, 1.2);

            // Base fabric cost from price snapshot or fallback
            const baseFabricCost = mfrPrice.unit_cost || mfrPrice.total_cost || mfrPrice.cost || (pb.dimensionAdjustedPrice || pb.basePrice || 40) * 0.5;

            // Get costs from options_breakdown if available, otherwise calculate
            const getOptionMfrCost = (type) => {
              const opt = optionsBreakdown.find(o => o.type === type);
              return opt ? opt.manufacturerCost : null;
            };

            const getAccessoryMfrCost = (code) => {
              const acc = accessoriesBreakdown.find(a => a.code === code);
              return acc ? acc.manufacturerCost : null;
            };

            // Motor costs - use snapshot data or fallback to defaults
            const motorBrand = cfg.motorBrand || cfg.chainType || '';
            const motorMfrCosts = {
              'motorized-app': 45, 'aok': 45,
              'motorized-remote': 47, 'dooya': 47,
              'plugin-motor': 55,
              'matter': 85, 'collise': 160, 'somfy': 600, 'bliss': 540
            };
            const motorCost = getOptionMfrCost('motorization') ?? (cfg.controlType === 'motorized' ? (motorMfrCosts[motorBrand] || 45) : 0);

            // Remote costs - use snapshot data or fallback
            const remoteMfrCosts = { 'single-channel': 6, '1-channel': 4.40, '5-channel': 6.60, '6-channel': 6.60, '15-channel': 11.35, '16-channel': 11.35 };
            const remoteCost = getOptionMfrCost('remote') ?? (cfg.remoteType ? (remoteMfrCosts[cfg.remoteType] || 0) : 0);

            // Solar panel cost - use snapshot data or fallback
            const solarCost = getOptionMfrCost('solar') ?? ((cfg.solarType === 'yes' && cfg.controlType === 'motorized') ? 20.5 : 0);

            // Smart Hub and USB Charger - use snapshot data or fallback
            const smartHubQty = parseInt(cfg.smartHubQty) || 0;
            const usbChargerQty = parseInt(cfg.usbChargerQty) || 0;
            const smartHubCost = getAccessoryMfrCost('smart-hub') ?? (smartHubQty * 23.50);
            const usbChargerCost = getAccessoryMfrCost('usb-charger') ?? (usbChargerQty * 5);

            // Cassette costs - use snapshot data or calculate
            const cassetteCost = getOptionMfrCost('valance_type') ?? (() => {
              const fabricCassettes = ['fabric-wrapped-v3', 'fabric-inserted-s1', 'curve-white-s2', 'fabric-wrapped-s3'];
              return fabricCassettes.includes(cfg.standardCassette) ? (2.20 * areaSqM * 0.5) : 0;
            })();

            // Bottom bar costs - use snapshot data or calculate
            const barCost = getOptionMfrCost('bottom_rail') ?? (() => {
              const fabricBars = ['type-c-fabric-wrapped', 'type-b', 'simple-rolling', 'type-d'];
              return fabricBars.includes(cfg.standardBottomBar) ? (2.20 * areaSqM * 0.5) : 0;
            })();

            // Calculate total manufacturer cost
            const totalMfrCost = baseFabricCost + motorCost + remoteCost + solarCost + smartHubCost + usbChargerCost + cassetteCost + barCost;

            // Use calculated total (now based on actual snapshot data)
            const mfrCost = totalMfrCost;

            // Calculate hardware subtotal
            const hardwareSubtotal = cassetteCost + barCost;
            // Calculate motorization subtotal
            const motorizationSubtotal = motorCost + remoteCost + solarCost;
            // Calculate accessories subtotal
            const accessoriesSubtotal = smartHubCost + usbChargerCost;

            return `
          <div style="margin-bottom: 24px; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;">

            <!-- Item Header -->
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%); color: white; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7;">Item ${idx + 1}</span>
                <h4 style="margin: 4px 0 0 0; font-size: 16px; font-weight: 600;">${escapeHtml(item.room_label || item.roomLabel || 'Blind')}</h4>
              </div>
              <div style="text-align: right;">
                <div style="font-size: 12px; opacity: 0.7;">${item.width}" x ${item.height}"</div>
                <div style="font-size: 14px; font-weight: 600; background: rgba(255,255,255,0.15); padding: 4px 12px; border-radius: 20px; margin-top: 4px;">Qty: ${item.quantity}</div>
              </div>
            </div>

            <div style="padding: 20px;">
              <!-- Cost Breakdown Grid -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">

                <!-- Base Product Card -->
                <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                  <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                      <svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/></svg>
                    </div>
                    <div>
                      <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Base Product</div>
                      <div style="font-size: 14px; font-weight: 600; color: #1f2937;">${cfg.fabricCode || 'Standard'}</div>
                    </div>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f5f3ff; border-radius: 8px;">
                    <div>
                      <div style="font-size: 11px; color: #6b7280;">Fabric + Size (${areaSqM.toFixed(2)} m)</div>
                      <div style="font-size: 10px; color: #9ca3af;">${cfg.lightFiltering || 'Standard'} | ${cfg.rollerType || 'Standard Roll'} | ${cfg.mountType || 'Standard Mount'}</div>
                    </div>
                    <div style="font-size: 18px; font-weight: 700; color: #7c3aed;">$${baseFabricCost.toFixed(2)}</div>
                  </div>
                </div>

                <!-- Hardware Card -->
                <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                  <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                      <svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M22 9V7h-2V5c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-2h2v-2h-2v-2h2v-2h-2V9h2zm-4 10H4V5h14v14z"/></svg>
                    </div>
                    <div>
                      <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Hardware</div>
                      <div style="font-size: 14px; font-weight: 600; color: #1f2937;">Cassette & Bar</div>
                    </div>
                  </div>
                  <div style="space-y: 8px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e5e7eb;">
                      <span style="font-size: 12px; color: #4b5563;">Cassette: ${cfg.standardCassette || 'Standard'}</span>
                      <span style="font-size: 13px; font-weight: 600; color: ${cassetteCost > 0 ? '#0891b2' : '#9ca3af'};">$${cassetteCost.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                      <span style="font-size: 12px; color: #4b5563;">Bottom Bar: ${cfg.standardBottomBar || 'Standard'}</span>
                      <span style="font-size: 13px; font-weight: 600; color: ${barCost > 0 ? '#0891b2' : '#9ca3af'};">$${barCost.toFixed(2)}</span>
                    </div>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #ecfeff; border-radius: 8px; margin-top: 8px;">
                    <span style="font-size: 11px; font-weight: 600; color: #0891b2;">HARDWARE SUBTOTAL</span>
                    <span style="font-size: 16px; font-weight: 700; color: #0891b2;">$${hardwareSubtotal.toFixed(2)}</span>
                  </div>
                </div>

                ${cfg.controlType === 'motorized' ? `
                <!-- Motorization Card -->
                <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                  <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                      <svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>
                    </div>
                    <div>
                      <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Motorization</div>
                      <div style="font-size: 14px; font-weight: 600; color: #1f2937;">${(motorBrand || 'AOK').replace('motorized-', '').toUpperCase()} Motor</div>
                    </div>
                  </div>
                  <div style="space-y: 8px;">
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e5e7eb;">
                      <span style="font-size: 12px; color: #4b5563;">Motor (${cfg.motorType || 'Standard'})</span>
                      <span style="font-size: 13px; font-weight: 600; color: #d97706;">$${motorCost.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e5e7eb;">
                      <span style="font-size: 12px; color: #4b5563;">Remote: ${cfg.remoteType || 'None'}</span>
                      <span style="font-size: 13px; font-weight: 600; color: ${remoteCost > 0 ? '#d97706' : '#9ca3af'};">$${remoteCost.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                      <span style="font-size: 12px; color: #4b5563;">Solar Panel</span>
                      <span style="font-size: 13px; font-weight: 600; color: ${solarCost > 0 ? '#d97706' : '#9ca3af'};">${cfg.solarType === 'yes' ? '$' + solarCost.toFixed(2) : '-'}</span>
                    </div>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #fffbeb; border-radius: 8px; margin-top: 8px;">
                    <span style="font-size: 11px; font-weight: 600; color: #d97706;">MOTOR SUBTOTAL</span>
                    <span style="font-size: 16px; font-weight: 700; color: #d97706;">$${motorizationSubtotal.toFixed(2)}</span>
                  </div>
                </div>
                ` : `
                <!-- Manual Control Card -->
                <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                  <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                      <svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                    </div>
                    <div>
                      <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Control</div>
                      <div style="font-size: 14px; font-weight: 600; color: #1f2937;">Manual / Chain</div>
                    </div>
                  </div>
                  <div style="padding: 12px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                    <div style="font-size: 12px; color: #6b7280;">Chain Side: <strong>${cfg.chainSide || 'Standard'}</strong></div>
                    <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">No additional cost</div>
                  </div>
                </div>
                `}

                ${(smartHubQty > 0 || usbChargerQty > 0) ? `
                <!-- Accessories Card -->
                <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                  <div style="display: flex; align-items: center; margin-bottom: 12px;">
                    <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                      <svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M20 6h-3V4c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM9 4h6v2H9V4zm11 16H4V8h16v12z"/></svg>
                    </div>
                    <div>
                      <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Accessories</div>
                      <div style="font-size: 14px; font-weight: 600; color: #1f2937;">Smart Add-ons</div>
                    </div>
                  </div>
                  <div style="space-y: 8px;">
                    ${smartHubQty > 0 ? `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #eff6ff; border-radius: 8px; margin-bottom: 8px;">
                      <div>
                        <div style="font-size: 12px; font-weight: 600; color: #1e40af;">Smart Hub</div>
                        <div style="font-size: 10px; color: #6b7280;">Qty: ${smartHubQty}</div>
                      </div>
                      <span style="font-size: 15px; font-weight: 700; color: #2563eb;">$${smartHubCost.toFixed(2)}</span>
                    </div>
                    ` : ''}
                    ${usbChargerQty > 0 ? `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #eff6ff; border-radius: 8px;">
                      <div>
                        <div style="font-size: 12px; font-weight: 600; color: #1e40af;">USB Charger</div>
                        <div style="font-size: 10px; color: #6b7280;">Qty: ${usbChargerQty}</div>
                      </div>
                      <span style="font-size: 15px; font-weight: 700; color: #2563eb;">$${usbChargerCost.toFixed(2)}</span>
                    </div>
                    ` : ''}
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #dbeafe; border-radius: 8px; margin-top: 8px;">
                    <span style="font-size: 11px; font-weight: 600; color: #1e40af;">ACCESSORIES SUBTOTAL</span>
                    <span style="font-size: 16px; font-weight: 700; color: #2563eb;">$${accessoriesSubtotal.toFixed(2)}</span>
                  </div>
                </div>
                ` : ''}

              </div>

              <!-- Total Section -->
              <div style="margin-top: 20px; background: linear-gradient(135deg, #065f46 0%, #047857 100%); border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="color: rgba(255,255,255,0.7); font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Unit Manufacturer Cost</div>
                  <div style="color: white; font-size: 28px; font-weight: 700; margin-top: 4px;">$${mfrCost.toFixed(2)}</div>
                </div>
                <div style="text-align: right;">
                  <div style="color: rgba(255,255,255,0.7); font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Line Total (x${item.quantity})</div>
                  <div style="color: white; font-size: 32px; font-weight: 800; margin-top: 4px;">$${(mfrCost * item.quantity).toFixed(2)}</div>
                </div>
              </div>

            </div>
          </div>
          `;
          }).join('')}

          ${order.accessories && order.accessories.length > 0 ? `
          <h4 style="margin-top: 20px; margin-bottom: 10px;">Accessories</h4>
          <table style="width: 100%; border-collapse: collapse; background: white; border: 2px solid #1a1a2e; max-width: 600px;">
            <thead>
              <tr style="background: #1a1a2e; color: white;">
                <th style="padding: 8px 12px; text-align: left; font-size: 11px; font-weight: 600; border: 1px solid #374151;">#</th>
                <th style="padding: 8px 12px; text-align: left; font-size: 11px; font-weight: 600; border: 1px solid #374151;">ACCESSORY</th>
                <th style="padding: 8px 12px; text-align: center; font-size: 11px; font-weight: 600; border: 1px solid #374151;">QTY</th>
                <th style="padding: 8px 12px; text-align: right; font-size: 11px; font-weight: 600; border: 1px solid #374151;">COST</th>
              </tr>
            </thead>
            <tbody>
              ${order.accessories.map((acc, idx) => `
              <tr style="background: white;">
                <td style="padding: 8px 12px; font-size: 11px; border: 1px solid #d1d5db;">${idx + 1}</td>
                <td style="padding: 8px 12px; font-size: 11px; font-weight: 600; border: 1px solid #d1d5db;">${escapeHtml(acc.name)}</td>
                <td style="padding: 8px 12px; text-align: center; font-size: 11px; font-weight: 700; border: 1px solid #d1d5db;">${acc.quantity}</td>
                <td style="padding: 8px 12px; text-align: right; font-size: 11px; font-weight: 700; border: 1px solid #d1d5db; color: #065f46;">$${(acc.cost || 0).toFixed(2)}</td>
              </tr>
              `).join('')}
            </tbody>
          </table>
          ` : ''}
        </div>

        <div class="order-detail-section">
          <h3>Status Actions</h3>
          <div class="status-actions">
            ${statusActions}
          </div>

          ${order.status === 'qa' ? `
            <div class="tracking-form" id="tracking-form">
              <h4>Shipping Information</h4>
              <div class="tracking-grid">
                <div class="form-group">
                  <label>Shipping Cost ($) <span style="color: #ef4444;">*</span></label>
                  <input type="number" id="shipping-cost" placeholder="0.00" step="0.01" min="0" value="${order.shipping || order.pricing?.shipping || ''}" style="font-weight: 600;">
                </div>
                <div class="form-group">
                  <label>Carrier <span style="color: #ef4444;">*</span></label>
                  <select id="tracking-carrier">
                    <option value="UPS">UPS</option>
                    <option value="FedEx">FedEx</option>
                    <option value="USPS">USPS</option>
                    <option value="DHL">DHL</option>
                    <option value="COSCO">COSCO (Freight)</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Tracking Number <span style="color: #ef4444;">*</span></label>
                  <input type="text" id="tracking-number" placeholder="Enter tracking number">
                </div>
                <div class="form-group">
                  <label>Estimated Delivery</label>
                  <input type="date" id="tracking-eta">
                </div>
              </div>
              <p style="margin-top: 12px; font-size: 12px; color: #6b7280;"><span style="color: #ef4444;">*</span> Required fields. Shipping cost will be added to the customer invoice.</p>
            </div>
          ` : ''}
        </div>

        <div class="order-detail-section">
          <h3>Status History</h3>
          <div class="status-timeline">
            ${(order.statusHistory || []).map((h, i, arr) => `
              <div class="timeline-item">
                <div class="timeline-dot ${i === arr.length - 1 ? 'current' : 'completed'}"></div>
                <div class="timeline-content">
                  <div class="timeline-status">${formatStatus(h.toStatus)}</div>
                  <div class="timeline-date">${formatDateTime(h.changedAt)} - ${h.reason || ''}</div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Get status action buttons
    function getStatusActions(status) {
      switch (status) {
        case 'order_received':
          return `<button class="btn-status start-production" onclick="updateStatus('manufacturing')">Start Production</button>`;
        case 'manufacturing':
          return `<button class="btn-status start-qa" onclick="updateStatus('qa')">Move to QA</button>`;
        case 'qa':
          return `
            <button class="btn-status start-production" onclick="updateStatus('manufacturing')">Back to Production</button>
            <button class="btn-status mark-shipped" onclick="shipOrder()">Mark as Shipped</button>
          `;
        case 'shipped':
          return `<span style="color: #10b981; font-weight: 500;">Order has been shipped</span>`;
        default:
          return '';
      }
    }

    // Update order status
    async function updateStatus(newStatus, notes = '') {
      const orderNumber = document.getElementById('modal-order-number').textContent;
      const order = orders.find(o => o.orderNumber === orderNumber);

      if (!order) return;

      const result = await api(`/api/manufacturer/orders/${order.id}/status`, {
        method: 'POST',
        body: JSON.stringify({ status: newStatus, notes })
      });

      if (result.success) {
        showToast('Status updated successfully', 'success');
        loadStats();
        loadOrders();
        openOrderDetail(order.id);
      } else {
        showToast(result.error || 'Failed to update status', 'error');
      }
    }

    // Ship order with tracking
    async function shipOrder() {
      const shippingCost = document.getElementById('shipping-cost').value;
      const carrier = document.getElementById('tracking-carrier').value;
      const trackingNumber = document.getElementById('tracking-number').value;
      const eta = document.getElementById('tracking-eta').value;

      if (!shippingCost || parseFloat(shippingCost) < 0) {
        showToast('Please enter a valid shipping cost', 'error');
        return;
      }

      if (!trackingNumber) {
        showToast('Please enter a tracking number', 'error');
        return;
      }

      const orderNumber = document.getElementById('modal-order-number').textContent;
      const order = orders.find(o => o.orderNumber === orderNumber);

      if (!order) return;

      // Update shipping cost first
      const shippingResult = await api(`/api/manufacturer/orders/${order.id}/shipping`, {
        method: 'POST',
        body: JSON.stringify({
          shippingCost: parseFloat(shippingCost)
        })
      });

      if (!shippingResult.success) {
        showToast(shippingResult.error || 'Failed to update shipping cost', 'error');
        return;
      }

      // Add tracking info
      const trackResult = await api(`/api/manufacturer/orders/${order.id}/tracking`, {
        method: 'POST',
        body: JSON.stringify({
          carrier,
          trackingNumber,
          estimatedDelivery: eta
        })
      });

      if (trackResult.success) {
        // Then update status to shipped
        await updateStatus('shipped', 'Shipped with tracking: ' + trackingNumber + ', Shipping cost: $' + parseFloat(shippingCost).toFixed(2));
      } else {
        showToast(trackResult.error || 'Failed to add tracking', 'error');
      }
    }

    // Close modal
    function closeModal() {
      document.getElementById('order-modal').classList.remove('show');
    }

    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        const tab = this.dataset.tab;
        currentStatus = tab === 'all' ? null : tab;
        loadOrders();
      });
    });

    // Search filter
    document.getElementById('filter-search').addEventListener('input', renderOrders);

    // Logout
    function logout() {
      localStorage.removeItem('mfrToken');
      localStorage.removeItem('mfrUser');
      window.location.href = '/manufacturer/login.html';
    }

    // Toast notification
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Helpers
    function formatStatus(status) {
      const map = {
        'order_received': 'Pending',
        'manufacturing': 'In Production',
        'qa': 'Quality Check',
        'shipped': 'Shipped'
      };
      return map[status] || status;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      return new Date(dateStr).toLocaleDateString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric'
      });
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return 'N/A';
      return new Date(dateStr).toLocaleString('en-US', {
        month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
      });
    }

    // Parse configuration JSON string to object
    function parseConfig(configStr) {
      if (!configStr) return {};
      if (typeof configStr === 'object') return configStr;
      try {
        return JSON.parse(configStr);
      } catch (e) {
        return {};
      }
    }

    // Calculate manufacturer cost for an item using price snapshot data
    function calculateItemMfrCost(item, cfg) {
      const pb = item.price_breakdown || {};
      // Get price snapshot data (check both singular and plural property names)
      const priceSnapshot = item.price_snapshot || item.price_snapshots || {};
      const mfrPrice = priceSnapshot.manufacturer_price || {};
      const customerPrice = priceSnapshot.customer_price || {};
      const optionsBreakdown = customerPrice.options_breakdown || [];
      const accessoriesBreakdown = customerPrice.accessories_breakdown || [];

      // Helper to get manufacturer cost from breakdown
      const getOptionMfrCost = (type) => {
        const opt = optionsBreakdown.find(o => o.type === type);
        return opt ? opt.manufacturerCost : null;
      };
      const getAccessoryMfrCost = (code) => {
        const acc = accessoriesBreakdown.find(a => a.code === code);
        return acc ? acc.manufacturerCost : null;
      };

      const widthM = item.width * 0.0254;
      const heightM = item.height * 0.0254;
      const areaSqM = Math.max(widthM * heightM, 1.2);

      // Base fabric cost
      const baseFabricCost = mfrPrice.unit_cost || mfrPrice.total_cost || mfrPrice.cost || (pb.dimensionAdjustedPrice || pb.basePrice || 40) * 0.5;

      // Motor costs
      const motorBrand = cfg.motorBrand || cfg.chainType || '';
      const motorMfrCosts = { 'motorized-app': 45, 'aok': 45, 'motorized-remote': 47, 'dooya': 47, 'plugin-motor': 55, 'matter': 85, 'collise': 160, 'somfy': 600, 'bliss': 540 };
      const motorCost = getOptionMfrCost('motorization') ?? (cfg.controlType === 'motorized' ? (motorMfrCosts[motorBrand] || 45) : 0);

      // Remote costs
      const remoteMfrCosts = { 'single-channel': 6, '1-channel': 4.40, '5-channel': 6.60, '6-channel': 6.60, '15-channel': 11.35, '16-channel': 11.35 };
      const remoteCost = getOptionMfrCost('remote') ?? (cfg.remoteType ? (remoteMfrCosts[cfg.remoteType] || 0) : 0);

      // Solar cost
      const solarCost = getOptionMfrCost('solar') ?? ((cfg.solarType === 'yes' && cfg.controlType === 'motorized') ? 20.5 : 0);

      // Accessories
      const smartHubCost = getAccessoryMfrCost('smart-hub') ?? ((parseInt(cfg.smartHubQty) || 0) * 23.50);
      const usbChargerCost = getAccessoryMfrCost('usb-charger') ?? ((parseInt(cfg.usbChargerQty) || 0) * 5);

      // Cassette and bar costs
      const fabricCassettes = ['fabric-wrapped-v3', 'fabric-inserted-s1', 'curve-white-s2', 'fabric-wrapped-s3'];
      const cassetteCost = getOptionMfrCost('valance_type') ?? (fabricCassettes.includes(cfg.standardCassette) ? (2.20 * areaSqM * 0.5) : 0);
      const fabricBars = ['type-c-fabric-wrapped', 'type-b', 'simple-rolling', 'type-d'];
      const barCost = getOptionMfrCost('bottom_rail') ?? (fabricBars.includes(cfg.standardBottomBar) ? (2.20 * areaSqM * 0.5) : 0);

      return baseFabricCost + motorCost + remoteCost + solarCost + smartHubCost + usbChargerCost + cassetteCost + barCost;
    }

    // Get motor brand + location OR chain side info based on control type
    function getMotorChainInfo(cfg) {
      const motorType = (cfg.motorType || '').toLowerCase();

      // For motorized blinds - show brand and chain side (motor position)
      if (motorType.includes('motor')) {
        let info = cfg.motorBrand || '';
        if (cfg.chainSide) {
          info += info ? ' / ' + cfg.chainSide : cfg.chainSide;
        }
        return info || '-';
      }

      // For manual/chain blinds - show chain side
      if (motorType.includes('manual') || motorType.includes('chain')) {
        return cfg.chainSide ? 'Chain: ' + cfg.chainSide : '-';
      }

      // For cordless
      if (motorType.includes('cordless') || cfg.cordless) {
        return 'Cordless';
      }

      // Default - show chain side if available
      return cfg.chainSide || cfg.motorBrand || '-';
    }

    // Get configuration value from item (checks multiple sources)
    function getConfigValue(item, key) {
      // Check direct property
      if (item[key]) return item[key];

      // Check configuration object
      try {
        const config = typeof item.configuration === 'string'
          ? JSON.parse(item.configuration || '{}')
          : (item.configuration || {});
        if (config[key]) return config[key];
      } catch (e) {}

      // Check price_breakdown
      if (item.price_breakdown && item.price_breakdown[key]) {
        return item.price_breakdown[key];
      }

      // Check price_snapshots
      if (item.price_snapshots && item.price_snapshots.manufacturer_price) {
        if (key === 'fabricCode' && item.price_snapshots.manufacturer_price.fabricCode) {
          return item.price_snapshots.manufacturer_price.fabricCode;
        }
      }

      return null;
    }

    // Format all configuration options as a table (collapsible for additional details)
    function formatAllOptionsTable(item) {
      let allOpts = {};

      // Gather from configuration
      try {
        const config = typeof item.configuration === 'string'
          ? JSON.parse(item.configuration || '{}')
          : (item.configuration || {});
        allOpts = { ...allOpts, ...config };
      } catch (e) {}

      // Add from price_breakdown
      if (item.price_breakdown) {
        const pb = item.price_breakdown;
        if (pb.fabricCode) allOpts.fabricCode = pb.fabricCode;
        if (pb.options) allOpts = { ...allOpts, ...pb.options };
      }

      // Filter out already-displayed values and empty values
      const displayedKeys = ['width', 'height', 'fabricCode', 'fabric', 'fabricName', 'motorType', 'controlType', 'motorBrand', 'mountType', 'valanceType', 'bottomRail', 'rollDirection', 'chainSide', 'cordless'];
      const entries = Object.entries(allOpts).filter(([k, v]) => v && v !== '{}' && !displayedKeys.includes(k));

      if (entries.length === 0) return '';

      return `
        <details style="margin-top: 12px;">
          <summary style="cursor: pointer; font-size: 13px; color: #3b82f6; padding: 8px 0; font-weight: 500;">
            + View ${entries.length} Additional Configuration Details
          </summary>
          <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; margin-top: 8px;">
            <thead>
              <tr style="background: #6b7280; color: white;">
                <th style="padding: 8px 12px; text-align: left; font-size: 11px; font-weight: 600;">Additional Option</th>
                <th style="padding: 8px 12px; text-align: left; font-size: 11px; font-weight: 600;">Value</th>
              </tr>
            </thead>
            <tbody>
              ${entries.map(([k, v], i) => `
                <tr style="border-bottom: 1px solid #e5e7eb; ${i % 2 === 0 ? '' : 'background: #f9fafb;'}">
                  <td style="padding: 8px 12px; font-size: 12px; color: #6b7280; font-weight: 500;">${formatConfigKey(k)}</td>
                  <td style="padding: 8px 12px; font-size: 12px; font-weight: 500;">${typeof v === 'object' ? JSON.stringify(v) : v}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </details>
      `;
    }

    // Keep the old function for compatibility
    function formatAllOptions(item) {
      return formatAllOptionsTable(item);
    }

    // Format configuration key to readable label
    function formatConfigKey(key) {
      const labels = {
        fabricCode: 'Fabric Code',
        fabricName: 'Fabric Name',
        fabricColor: 'Fabric Color',
        motorType: 'Motor Type',
        motorBrand: 'Motor Brand',
        controlType: 'Control Type',
        mountType: 'Mount Type',
        valanceType: 'Valance Style',
        bottomRail: 'Bottom Rail',
        rollDirection: 'Roll Direction',
        chainSide: 'Chain Side',
        cordless: 'Cordless',
        roomLabel: 'Room Label',
        width: 'Width',
        height: 'Height',
        quantity: 'Quantity'
      };
      return labels[key] || key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
    }

    function formatOptions(config) {
      if (!config || config === '{}') return 'Standard';
      try {
        const opts = typeof config === 'string' ? JSON.parse(config) : config;
        return Object.entries(opts).map(([k, v]) => `${k}: ${v}`).join(', ') || 'Standard';
      } catch {
        return 'Standard';
      }
    }

    // Format address object to string
    function formatAddress(addr) {
      if (!addr) return 'N/A';
      if (typeof addr === 'string') return escapeHtml(addr);
      // Handle address object
      const parts = [];
      if (addr.street) parts.push(addr.street);
      if (addr.city) parts.push(addr.city);
      if (addr.state) parts.push(addr.state);
      if (addr.zip) parts.push(addr.zip);
      if (addr.country && addr.country !== 'US') parts.push(addr.country);
      return parts.length > 0 ? escapeHtml(parts.join(', ')) : 'N/A';
    }

    function escapeHtml(str) {
      if (!str) return '';
      if (typeof str !== 'string') str = String(str);
      return str.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[c]);
    }

    // Download order as Excel (CSV format)
    function downloadOrderExcel() {
      if (!currentOrderDetail) {
        showToast('No order loaded', 'error');
        return;
      }
      const order = currentOrderDetail;

      // Build CSV content
      let csv = 'MANUFACTURING ORDER SHEET\n';
      csv += `Order Number,${order.orderNumber}\n`;
      csv += `Order Date,${formatDate(order.createdAt)}\n`;
      csv += `Status,${formatStatus(order.status)}\n`;
      csv += `Customer Name,${order.customer?.name || 'N/A'}\n`;
      csv += `Customer Email,${order.customer?.email || 'N/A'}\n`;
      csv += `Customer Phone,${order.customer?.phone || 'N/A'}\n`;
      csv += `Shipping Address,"${formatAddress(order.customer?.address || order.shipping_address)}"\n`;
      csv += '\n';
      csv += 'ITEMS TO MANUFACTURE\n';
      csv += '#,Room,Qty,Width,Height,Fabric,Light Filter,Cassette,Bottom Bar,Roll Type,Mount,Chain Side,Control,Motor Brand,Motor Type,Remote,Solar,Smart Hub,USB,Unit Cost,Line Cost\n';

      order.items.forEach((item, idx) => {
        const cfg = parseConfig(item.configuration || item.options);
        const mfrCost = calculateItemMfrCost(item, cfg);
        const lineCost = mfrCost * item.quantity;

        csv += `${idx + 1},`;
        csv += `"${item.room_label || item.roomLabel || '-'}",`;
        csv += `${item.quantity},`;
        csv += `${item.width},`;
        csv += `${item.height},`;
        csv += `${cfg.fabricCode || '-'},`;
        csv += `${cfg.lightFiltering || '-'},`;
        csv += `${cfg.standardCassette || '-'},`;
        csv += `${cfg.standardBottomBar || '-'},`;
        csv += `${cfg.rollerType || '-'},`;
        csv += `${cfg.mountType || '-'},`;
        csv += `${cfg.chainSide || '-'},`;
        csv += `${cfg.controlType || '-'},`;
        csv += `${cfg.motorBrand || cfg.chainType || '-'},`;
        csv += `${cfg.motorType || '-'},`;
        csv += `${cfg.remoteType || '-'},`;
        csv += `${cfg.solarType === 'yes' ? 'YES' : '-'},`;
        csv += `${cfg.smartHubQty > 0 ? cfg.smartHubQty : '-'},`;
        csv += `${cfg.usbChargerQty > 0 ? cfg.usbChargerQty : '-'},`;
        csv += `$${mfrCost.toFixed(2)},`;
        csv += `$${lineCost.toFixed(2)}\n`;
      });

      const totalMfrCost = order.items.reduce((sum, i) => {
        const cfg = parseConfig(i.configuration || i.options);
        return sum + (calculateItemMfrCost(i, cfg) * i.quantity);
      }, 0);
      csv += `\n,,,,,,,,,,,,,,,,,,TOTAL:,$${totalMfrCost.toFixed(2)}\n`;

      // Download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `Order_${order.orderNumber}_${new Date().toISOString().slice(0, 10)}.csv`;
      link.click();
      showToast('Excel (CSV) downloaded', 'success');
    }

    // Download order as PDF
    function downloadOrderPDF() {
      if (!currentOrderDetail) {
        showToast('No order loaded', 'error');
        return;
      }
      const order = currentOrderDetail;

      // Create printable HTML content
      const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Order ${order.orderNumber}</title>
          <style>
            body { font-family: Arial, sans-serif; font-size: 12px; margin: 20px; }
            h1 { color: #1a1a2e; font-size: 18px; margin-bottom: 5px; }
            h2 { color: #1a1a2e; font-size: 14px; margin: 15px 0 8px 0; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
            .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
            .order-info { margin-bottom: 15px; }
            .info-row { margin: 3px 0; }
            .label { font-weight: bold; color: #666; display: inline-block; width: 120px; }
            table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 10px; }
            th { background: #1a1a2e; color: white; padding: 6px 4px; text-align: left; font-weight: 600; }
            td { padding: 5px 4px; border-bottom: 1px solid #ddd; }
            tr:nth-child(even) { background: #f9f9f9; }
            .total-row { background: #1a1a2e !important; color: white; font-weight: bold; }
            .text-right { text-align: right; }
            .cost { color: #065f46; font-weight: 600; }
            @media print { body { margin: 0; } }
          </style>
        </head>
        <body>
          <div class="header">
            <div>
              <h1>MANUFACTURING ORDER SHEET</h1>
              <p style="color: #666;">Peekaboo Shades</p>
            </div>
            <div style="text-align: right;">
              <strong style="font-size: 16px; color: #3b82f6;">${order.orderNumber}</strong><br>
              <span style="color: #666;">${formatDate(order.createdAt)}</span>
            </div>
          </div>

          <h2>Order Information</h2>
          <div class="order-info">
            <div class="info-row"><span class="label">Status:</span> ${formatStatus(order.status)}</div>
            <div class="info-row"><span class="label">Customer:</span> ${order.customer?.name || 'N/A'}</div>
            <div class="info-row"><span class="label">Email:</span> ${order.customer?.email || 'N/A'}</div>
            <div class="info-row"><span class="label">Phone:</span> ${order.customer?.phone || 'N/A'}</div>
            <div class="info-row"><span class="label">Ship To:</span> ${formatAddress(order.customer?.address)}</div>
          </div>

          <h2>Items to Manufacture (${order.items.length} items, ${order.items.reduce((s, i) => s + i.quantity, 0)} units)</h2>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Room</th>
                <th>Qty</th>
                <th>W x H</th>
                <th>Fabric</th>
                <th>Light</th>
                <th>Cassette</th>
                <th>Bottom Bar</th>
                <th>Roll</th>
                <th>Mount</th>
                <th>Control</th>
                <th>Motor</th>
                <th>Remote</th>
                <th>Solar</th>
                <th>Unit Cost</th>
                <th>Line Cost</th>
              </tr>
            </thead>
            <tbody>
              ${order.items.map((item, idx) => {
                const cfg = parseConfig(item.configuration || item.options);
                const mfrCost = calculateItemMfrCost(item, cfg);
                const lineCost = mfrCost * item.quantity;
                return `
                  <tr>
                    <td>${idx + 1}</td>
                    <td>${item.room_label || item.roomLabel || '-'}</td>
                    <td><strong>${item.quantity}</strong></td>
                    <td>${item.width}" x ${item.height}"</td>
                    <td><strong>${cfg.fabricCode || '-'}</strong></td>
                    <td>${cfg.lightFiltering || '-'}</td>
                    <td>${cfg.standardCassette || '-'}</td>
                    <td>${cfg.standardBottomBar || '-'}</td>
                    <td>${cfg.rollerType || '-'}</td>
                    <td>${cfg.mountType || '-'}</td>
                    <td>${cfg.controlType || '-'}</td>
                    <td>${cfg.motorBrand || '-'}</td>
                    <td>${cfg.remoteType || '-'}</td>
                    <td>${cfg.solarType === 'yes' ? 'YES' : '-'}</td>
                    <td class="cost text-right">$${mfrCost.toFixed(2)}</td>
                    <td class="cost text-right">$${lineCost.toFixed(2)}</td>
                  </tr>
                `;
              }).join('')}
              <tr class="total-row">
                <td colspan="14" class="text-right">TOTAL MANUFACTURER COST:</td>
                <td colspan="2" class="text-right">$${order.items.reduce((sum, i) => {
                  const cfg = parseConfig(i.configuration || i.options);
                  return sum + (calculateItemMfrCost(i, cfg) * i.quantity);
                }, 0).toFixed(2)}</td>
              </tr>
            </tbody>
          </table>

          <p style="margin-top: 30px; color: #666; font-size: 10px;">
            Generated on ${new Date().toLocaleString()} | Peekaboo Shades Manufacturing Portal
          </p>
        </body>
        </html>
      `;

      // Open print dialog (which can save as PDF)
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
      }, 250);
      showToast('PDF ready - use Print dialog to save', 'success');
    }

    // Init
    console.log('Manufacturer Portal: Initializing...');
    console.log('Token:', token ? 'Present' : 'Missing');
    console.log('User:', user);

    loadStats();
    loadOrders();

    // Auto-refresh every 60 seconds (was 30)
    setInterval(() => {
      console.log('Auto-refresh triggered');
      loadStats();
      loadOrders();
    }, 60000);
  </script>
</body>
</html>
