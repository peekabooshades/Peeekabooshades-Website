<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shopping Cart - Peekaboo Shades</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="top-bar-container">
      <div class="top-bar-left">
        <span><i class="fas fa-phone"></i> 1-800-SHADES</span>
        <span><i class="fas fa-envelope"></i> info@peekabooshades.com</span>
      </div>
      <div class="top-bar-right">
        <a href="#">Free Samples</a>
        <a href="#">Trade Program</a>
        <a href="#">Help</a>
      </div>
    </div>
  </div>

  <!-- Main Header -->
  <header class="main-header">
    <div class="header-container">
      <a href="/" class="logo">
        <img src="/images/peekabooshades_logo.jpeg" alt="Peekaboo Shades" class="logo-img" style="height: 50px; width: auto;">
      </a>

      <nav class="main-nav">
        <ul>
          <li class="nav-dropdown">
            <a href="/shop">Windows Blinds & Shades <i class="fas fa-chevron-down"></i></a>
            <div class="nav-dropdown-menu">
              <a href="/shop?category=roller-shades">Roller Shades</a>
              <a href="/shop?category=roman-shades">Roman Shades</a>
              <a href="/shop?category=natural-woven-shades">Natural Woven Shades</a>
              <a href="/shop?category=honeycomb-shades">Honeycomb Shades</a>
              <a href="/shop?category=drapes">Drapes</a>
            </div>
          </li>
          <li><a href="#">Curtains</a></li>
          <li><a href="#">Look up My Order</a></li>
          <li><a href="#">Bulk Orders/Wholesale</a></li>
          <li><a href="#">Contact Us</a></li>
          <li><a href="#">My Account</a></li>
        </ul>
      </nav>

      <div class="header-icons">
        <div class="search-bar">
          <input type="text" placeholder="Search products...">
          <button><i class="fas fa-search"></i></button>
        </div>
        <a href="#" class="header-icon"><i class="far fa-heart"></i></a>
        <a href="#" class="header-icon"><i class="far fa-user"></i></a>
        <a href="/cart" class="header-icon">
          <i class="fas fa-shopping-cart"></i>
          <span class="cart-count" id="cartCount">0</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Cart Section -->
  <section class="cart-section">
    <div class="cart-container">
      <h1 class="cart-title">Shopping Cart</h1>

      <div id="cartContent">
        <!-- Cart content will be loaded dynamically -->
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="main-footer">
    <div class="footer-container">
      <div class="footer-grid">
        <div class="footer-brand">
          <div class="footer-logo">
            <img src="/images/peekabooshades_logo.jpeg" alt="Peekaboo Shades" style="height: 40px; width: auto;">
          </div>
          <p class="footer-description">
            Custom window blinds and shades designed to transform your space.
            Premium quality, affordable prices, and exceptional service.
          </p>
          <div class="footer-social">
            <a href="#" class="social-icon"><i class="fab fa-facebook-f"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-instagram"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-twitter"></i></a>
            <a href="#" class="social-icon"><i class="fab fa-pinterest"></i></a>
          </div>
        </div>

        <div class="footer-column">
          <h4>Products</h4>
          <ul>
            <li><a href="/shop?category=roller-shades">Roller Shades</a></li>
            <li><a href="/shop?category=roman-shades">Roman Shades</a></li>
            <li><a href="/shop?category=natural-woven-shades">Natural Woven</a></li>
            <li><a href="/shop?category=honeycomb-shades">Honeycomb Shades</a></li>
            <li><a href="/shop?category=drapes">Drapes</a></li>
          </ul>
        </div>

        <div class="footer-column">
          <h4>Customer Service</h4>
          <ul>
            <li><a href="#">Track Order</a></li>
            <li><a href="#">Returns & Exchanges</a></li>
            <li><a href="#">Shipping Info</a></li>
            <li><a href="#">FAQs</a></li>
            <li><a href="#">Contact Us</a></li>
          </ul>
        </div>

        <div class="footer-column">
          <h4>Talk To Us</h4>
          <ul>
            <li><a href="#">About Us</a></li>
            <li><a href="#">Careers</a></li>
            <li><a href="#">Press</a></li>
            <li><a href="#">Blog</a></li>
          </ul>
        </div>

        <div class="footer-column">
          <h4>Resources</h4>
          <ul>
            <li><a href="#">Measuring Guide</a></li>
            <li><a href="#">Installation Guide</a></li>
            <li><a href="#">Free Samples</a></li>
            <li><a href="#">Trade Program</a></li>
          </ul>
        </div>
      </div>

      <div class="footer-bottom">
        <p class="footer-copyright">&copy; 2024 Peekaboo Shades. All rights reserved.</p>
        <div class="footer-links">
          <a href="#">Privacy Policy</a>
          <a href="#">Terms of Service</a>
          <a href="#">Accessibility</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- Checkout Modal -->
  <div class="quote-modal" id="checkoutModal">
    <div class="quote-content" style="max-width: 600px;">
      <div class="quote-header">
        <h3>Checkout</h3>
        <button class="quote-close" onclick="closeCheckout()">&times;</button>
      </div>
      <div class="quote-body">
        <form id="checkoutForm" onsubmit="submitOrder(event)">
          <h4 style="margin-bottom: 15px; color: var(--text-brown);">Contact Information</h4>
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="customerName" required>
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="customerEmail" required>
          </div>
          <div class="form-group">
            <label>Phone *</label>
            <input type="tel" id="customerPhone" required>
          </div>

          <h4 style="margin: 25px 0 15px; color: var(--text-brown);">Shipping Address</h4>
          <div class="form-group">
            <label>Street Address *</label>
            <input type="text" id="streetAddress" required>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label>City *</label>
              <input type="text" id="city" required>
            </div>
            <div class="form-group">
              <label>State *</label>
              <select id="state" required onchange="updateCheckoutTax()">
                <option value="">Select State</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
                <option value="DC">Washington D.C.</option>
              </select>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label>ZIP Code *</label>
              <input type="text" id="zipCode" required>
            </div>
            <div class="form-group">
              <label>Country</label>
              <select id="country">
                <option value="US">United States</option>
                <option value="CA">Canada</option>
              </select>
            </div>
          </div>

          <div class="price-summary" style="margin-top: 25px;">
            <div class="price-row">
              <span>Subtotal</span>
              <span>$<span id="checkoutSubtotal">0.00</span></span>
            </div>
            <div class="price-row">
              <span>Shipping</span>
              <span>$<span id="checkoutShipping">0.00</span></span>
            </div>
            <div class="price-row">
              <span>Tax (estimated)</span>
              <span>$<span id="checkoutTax">0.00</span></span>
            </div>
            <div class="price-row total">
              <span>Total</span>
              <span>$<span id="checkoutTotal">0.00</span></span>
            </div>
          </div>

          <button type="submit" class="submit-quote-btn" style="margin-top: 20px;">
            <i class="fas fa-lock"></i> Place Order
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script src="/js/app.js"></script>
  <script>
    // US State Sales Tax Rates - Combined State + Average Local (July 2025)
    // Source: Tax Foundation - https://taxfoundation.org/data/all/state/2024-sales-taxes/
    const STATE_TAX_RATES = {
      'AL': 0.0944,  // Alabama
      'AK': 0.0182,  // Alaska (local only, no state tax)
      'AZ': 0.0842,  // Arizona
      'AR': 0.0951,  // Arkansas
      'CA': 0.0898,  // California
      'CO': 0.0779,  // Colorado
      'CT': 0.0635,  // Connecticut
      'DE': 0.0000,  // Delaware (no sales tax)
      'FL': 0.0702,  // Florida
      'GA': 0.0744,  // Georgia
      'HI': 0.0444,  // Hawaii
      'ID': 0.0603,  // Idaho
      'IL': 0.0882,  // Illinois
      'IN': 0.0700,  // Indiana
      'IA': 0.0694,  // Iowa
      'KS': 0.0875,  // Kansas
      'KY': 0.0600,  // Kentucky
      'LA': 0.0955,  // Louisiana
      'ME': 0.0550,  // Maine
      'MD': 0.0600,  // Maryland
      'MA': 0.0625,  // Massachusetts
      'MI': 0.0600,  // Michigan
      'MN': 0.0783,  // Minnesota
      'MS': 0.0707,  // Mississippi
      'MO': 0.0829,  // Missouri
      'MT': 0.0000,  // Montana (no sales tax)
      'NE': 0.0702,  // Nebraska
      'NV': 0.0823,  // Nevada
      'NH': 0.0000,  // New Hampshire (no sales tax)
      'NJ': 0.0664,  // New Jersey
      'NM': 0.0729,  // New Mexico
      'NY': 0.0852,  // New York
      'NC': 0.0700,  // North Carolina
      'ND': 0.0696,  // North Dakota
      'OH': 0.0724,  // Ohio
      'OK': 0.0898,  // Oklahoma
      'OR': 0.0000,  // Oregon (no sales tax)
      'PA': 0.0634,  // Pennsylvania
      'RI': 0.0700,  // Rhode Island
      'SC': 0.0746,  // South Carolina
      'SD': 0.0640,  // South Dakota
      'TN': 0.0955,  // Tennessee
      'TX': 0.0825,  // Texas
      'UT': 0.0719,  // Utah
      'VT': 0.0624,  // Vermont
      'VA': 0.0575,  // Virginia
      'WA': 0.0938,  // Washington
      'WV': 0.0655,  // West Virginia
      'WI': 0.0543,  // Wisconsin
      'WY': 0.0536,  // Wyoming
      'DC': 0.0600,  // District of Columbia
      'PR': 0.1150,  // Puerto Rico
    };

    // Get tax rate for a state code
    function getTaxRateForState(stateCode) {
      const code = (stateCode || '').toUpperCase().trim();
      return STATE_TAX_RATES[code] || 0.0700; // Default 7% if state not found
    }

    // Product images for display
    const productImages = {
      'affordable-custom-roller-blinds': 'https://images.unsplash.com/photo-1615874959474-d609969a20ed?w=200',
      'energy-efficient-roman-shades': 'https://images.unsplash.com/photo-1616046229478-9901c5536a45?w=200',
      'affordable-zebra-window-blinds': 'https://images.unsplash.com/photo-1586023492125-27b2c045efd7?w=200',
      'default': 'https://images.unsplash.com/photo-1615874959474-d609969a20ed?w=200'
    };

    let cartItems = [];
    let subtotal = 0;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadCart();
      updateCartCount();
    });

    // Order summary from server
    let orderSummary = null;

    // Load cart - ALL pricing comes from server
    async function loadCart() {
      const sessionId = getSessionId();

      try {
        const response = await fetch(`/api/cart/${sessionId}`);
        const result = await response.json();

        if (result.success) {
          cartItems = result.data;
          subtotal = result.subtotal;

          // Get complete order totals from server (tax, shipping, etc.)
          if (cartItems.length > 0) {
            await calculateOrderTotal();
          }

          renderCart();
        }
      } catch (error) {
        console.error('Error loading cart:', error);
        cartItems = [];
        renderCart();
      }
    }

    // Calculate order total from server - NEVER calculate locally
    async function calculateOrderTotal() {
      try {
        // Prepare items for pricing API
        const items = cartItems.map(item => ({
          id: item.id,
          productId: item.product_id,
          width: item.width,
          height: item.height,
          quantity: item.quantity,
          options: typeof item.configuration === 'string'
            ? JSON.parse(item.configuration)
            : item.configuration,
          extendedWarranty: item.extended_warranty === 1
        }));

        const response = await fetch('/api/calculate-order-total', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            items,
            shippingAddress: {
              state: localStorage.getItem('shippingState') || 'CA',
              country: 'US'
            },
            promoCode: localStorage.getItem('promoCode') || null
          })
        });

        const result = await response.json();
        if (result.success) {
          orderSummary = result.summary;
          subtotal = result.summary.subtotal;
        }
      } catch (error) {
        console.error('Error calculating order total:', error);
        // Fallback: use cart subtotal only, no tax/shipping
        orderSummary = {
          subtotal: subtotal,
          tax: { amount: 0, description: 'Tax calculated at checkout' },
          shipping: { amount: 0, description: 'Calculated at checkout' },
          discount: { amount: 0 },
          grandTotal: subtotal
        };
      }
    }

    // Render cart - uses server-calculated totals
    function renderCart() {
      const container = document.getElementById('cartContent');

      if (cartItems.length === 0) {
        container.innerHTML = `
          <div class="empty-cart">
            <div class="empty-cart-icon"><i class="fas fa-shopping-cart"></i></div>
            <h2>Your cart is empty</h2>
            <p>Looks like you haven't added any items to your cart yet.</p>
            <a href="/shop" class="btn-add-cart" style="display: inline-block; padding: 15px 40px;">
              Continue Shopping
            </a>
          </div>
        `;
        return;
      }

      // Use server-calculated values (NEVER calculate locally)
      const summary = orderSummary || {
        subtotal: subtotal,
        tax: { amount: 0 },
        shipping: { amount: 0 },
        discount: { amount: 0 },
        grandTotal: subtotal
      };

      const tax = summary.tax.amount;
      const shipping = summary.shipping.amount;
      const discount = summary.discount.amount;
      const total = summary.grandTotal;

      container.innerHTML = `
        <div class="cart-grid">
          <div class="cart-items">
            ${cartItems.map(item => renderCartItem(item)).join('')}
          </div>

          <div class="cart-summary">
            <h3>Order Summary</h3>
            <div class="summary-row">
              <span>Subtotal (${cartItems.length} items)</span>
              <span>$${subtotal.toFixed(2)}</span>
            </div>
            <div class="summary-row">
              <span>Shipping</span>
              <span>${shipping === 0 ? 'FREE' : '$' + shipping.toFixed(2)}</span>
            </div>
            <div class="summary-row">
              <span>Estimated Tax</span>
              <span>$${tax.toFixed(2)}</span>
            </div>
            <div class="summary-row total">
              <span>Total</span>
              <span>$${total.toFixed(2)}</span>
            </div>

            <button class="checkout-btn" onclick="openCheckout()">
              Proceed to Checkout
            </button>

            <a href="/shop" class="continue-shopping">
              <i class="fas fa-arrow-left"></i> Continue Shopping
            </a>

            <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-light);">
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">We accept</p>
              <div style="display: flex; gap: 10px;">
                <i class="fab fa-cc-visa" style="font-size: 28px; color: #1a1f71;"></i>
                <i class="fab fa-cc-mastercard" style="font-size: 28px; color: #eb001b;"></i>
                <i class="fab fa-cc-amex" style="font-size: 28px; color: #006fcf;"></i>
                <i class="fab fa-cc-paypal" style="font-size: 28px; color: #003087;"></i>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Render cart item
    function renderCartItem(item) {
      const config = typeof item.configuration === 'string'
        ? JSON.parse(item.configuration)
        : item.configuration || {};

      const configString = Object.entries(config)
        .filter(([key, value]) => value && key !== 'smartHubQty' && key !== 'usbChargerQty')
        .map(([key, value]) => `${formatKey(key)}: ${value}`)
        .join(' | ');

      // Use line_total which already includes (unit_price Ã— quantity) + accessories
      // NEVER use unit_price * quantity as it excludes accessories
      let itemPrice = item.line_total || item.lineTotal || (item.unit_price || item.unitPrice) * item.quantity;

      const imageUrl = item.image_url || productImages[item.product_name?.toLowerCase().replace(/\s+/g, '-')] || productImages.default;

      return `
        <div class="cart-item" data-id="${item.id}">
          <div class="cart-item-image">
            <img src="${imageUrl}" alt="${item.product_name || item.productName}">
          </div>
          <div class="cart-item-info">
            <h3 class="cart-item-title">${item.product_name || item.productName}</h3>
            <p class="cart-item-config">
              ${item.width}" W x ${item.height}" H
              ${item.room_label || item.roomLabel ? ' | ' + (item.room_label || item.roomLabel) : ''}
              ${configString ? '<br>' + configString : ''}
              ${item.extended_warranty || item.extendedWarranty ? '<br><strong>Extended Warranty Included</strong>' : ''}
            </p>
            <div class="cart-item-actions">
              <div class="quantity-input" style="width: auto;">
                <button class="quantity-btn" onclick="updateItemQuantity('${item.id}', -1)">-</button>
                <input type="number" value="${item.quantity}" min="1" max="99" style="width: 50px;"
                       onchange="setItemQuantity('${item.id}', this.value)">
                <button class="quantity-btn" onclick="updateItemQuantity('${item.id}', 1)">+</button>
              </div>
              <span class="cart-item-price">$${itemPrice.toFixed(2)}</span>
              <button class="cart-item-remove" onclick="removeItem('${item.id}')">
                <i class="fas fa-trash"></i> Remove
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Format config key
    function formatKey(key) {
      return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
    }

    // Update item quantity
    async function updateItemQuantity(itemId, delta) {
      const item = cartItems.find(i => i.id === itemId);
      if (!item) return;

      const newQuantity = item.quantity + delta;
      if (newQuantity < 1) {
        removeItem(itemId);
        return;
      }

      await setItemQuantity(itemId, newQuantity);
    }

    // Set item quantity
    async function setItemQuantity(itemId, quantity) {
      const newQuantity = parseInt(quantity);
      if (newQuantity < 1) return;

      try {
        await fetch(`/api/cart/${itemId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity: newQuantity })
        });
      } catch (error) {
        // Update local storage
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const item = cart.find(i => i.id === itemId);
        if (item) {
          item.quantity = newQuantity;
          localStorage.setItem('cart', JSON.stringify(cart));
        }
      }

      loadCart();
      updateCartCount();
    }

    // Remove item
    async function removeItem(itemId) {
      try {
        await fetch(`/api/cart/${itemId}`, { method: 'DELETE' });
      } catch (error) {
        // Remove from local storage
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const index = cart.findIndex(i => i.id === itemId);
        if (index > -1) {
          cart.splice(index, 1);
          localStorage.setItem('cart', JSON.stringify(cart));
        }
      }

      showToast('Item removed from cart');
      loadCart();
      updateCartCount();
    }

    // Open checkout
    function openCheckout() {
      // BUG-008 FIX: Get selected state, show estimated if none selected
      const stateSelect = document.getElementById('state');
      const stateCode = stateSelect.value;

      // Calculate values
      const taxRate = stateCode ? getTaxRateForState(stateCode) : 0;
      const tax = subtotal * taxRate;
      const shipping = subtotal > 99 ? 0 : 9.99;
      const total = subtotal + tax + shipping;

      // Update display values
      document.getElementById('checkoutSubtotal').textContent = subtotal.toFixed(2);
      document.getElementById('checkoutShipping').textContent = shipping.toFixed(2);
      document.getElementById('checkoutTax').textContent = tax.toFixed(2);
      document.getElementById('checkoutTotal').textContent = total.toFixed(2);

      // BUG-008 FIX: Update tax label correctly - iterate all price rows like updateCheckoutTax does
      const taxRows = document.querySelectorAll('.price-row');
      taxRows.forEach(row => {
        const label = row.querySelector('span:first-child');
        if (label && (label.textContent.includes('Tax') || label.textContent.includes('estimated'))) {
          if (stateCode) {
            label.innerHTML = `Tax (${(taxRate * 100).toFixed(2)}%)`;
          } else {
            label.innerHTML = `Tax (select state)`;
          }
        }
      });

      document.getElementById('checkoutModal').classList.add('active');
    }

    // Update tax when state changes
    function updateCheckoutTax() {
      const stateCode = document.getElementById('state').value;

      // BUG-008 FIX: Handle both selected and unselected state
      const taxRate = stateCode ? getTaxRateForState(stateCode) : 0;
      const tax = subtotal * taxRate;
      const shipping = subtotal > 99 ? 0 : 9.99;
      const total = subtotal + tax + shipping;

      document.getElementById('checkoutTax').textContent = tax.toFixed(2);
      document.getElementById('checkoutTotal').textContent = total.toFixed(2);

      // Update tax label with rate or prompt to select state
      const taxRows = document.querySelectorAll('.price-row');
      taxRows.forEach(row => {
        const label = row.querySelector('span:first-child');
        if (label && (label.textContent.includes('Tax') || label.textContent.includes('select state'))) {
          if (stateCode) {
            label.innerHTML = `Tax (${(taxRate * 100).toFixed(2)}%)`;
          } else {
            label.innerHTML = `Tax (select state)`;
          }
        }
      });
    }

    // Close checkout
    function closeCheckout() {
      document.getElementById('checkoutModal').classList.remove('active');
    }

    // Submit order
    async function submitOrder(e) {
      e.preventDefault();

      const sessionId = getSessionId();
      const stateCode = document.getElementById('state').value;

      // BUG-008 FIX: Validate state is selected before submission
      if (!stateCode) {
        showToast('Please select your state for accurate tax calculation', 'error');
        document.getElementById('state').focus();
        return;
      }

      const taxRate = getTaxRateForState(stateCode);
      const tax = subtotal * taxRate;
      const shipping = subtotal > 99 ? 0 : 9.99;

      const orderData = {
        sessionId,
        customerName: document.getElementById('customerName').value,
        customerEmail: document.getElementById('customerEmail').value,
        customerPhone: document.getElementById('customerPhone').value,
        shippingAddress: `${document.getElementById('streetAddress').value}, ${document.getElementById('city').value}, ${stateCode} ${document.getElementById('zipCode').value}, ${document.getElementById('country').value}`,
        shippingState: stateCode,
        taxRate: taxRate,
        subtotal,
        tax,
        shipping
      };

      try {
        const response = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orderData)
        });

        const result = await response.json();

        if (result.success) {
          localStorage.removeItem('cart');
          closeCheckout();
          showOrderConfirmation(result.orderNumber);
        }
      } catch (error) {
        // Simulate successful order
        localStorage.removeItem('cart');
        closeCheckout();
        showOrderConfirmation('ORD-' + Date.now().toString(36).toUpperCase());
      }
    }

    // Show order confirmation
    function showOrderConfirmation(orderNumber) {
      document.getElementById('cartContent').innerHTML = `
        <div class="empty-cart" style="padding: 80px 20px;">
          <div style="width: 80px; height: 80px; background: var(--success-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px;">
            <i class="fas fa-check" style="font-size: 40px; color: white;"></i>
          </div>
          <h2 style="color: var(--success-green);">Order Placed Successfully!</h2>
          <p style="margin-bottom: 10px;">Thank you for your order.</p>
          <p style="font-size: 18px; font-weight: bold; color: var(--primary-brown);">Order #${orderNumber}</p>
          <p style="color: var(--text-muted); margin-top: 15px;">
            A confirmation email has been sent to your email address.
          </p>
          <a href="/shop" class="btn-add-cart" style="display: inline-block; padding: 15px 40px; margin-top: 25px;">
            Continue Shopping
          </a>
        </div>
      `;

      updateCartCount();
    }

    // Close modal on outside click
    document.getElementById('checkoutModal').addEventListener('click', function(e) {
      if (e.target === this) closeCheckout();
    });
  </script>
</body>
</html>
