<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>New Order - Dealer Portal</title>
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f5f7fa;
      min-height: 100vh;
    }

    /* Header */
    .dealer-header {
      background: #2d5a27;
      color: white;
      padding: 0 24px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }
    .dealer-header-left { display: flex; align-items: center; gap: 16px; }
    .dealer-header img { height: 32px; }
    .dealer-header h1 { font-size: 18px; font-weight: 600; }
    .tier-badge {
      background: rgba(255,255,255,0.2);
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .tier-badge.bronze { background: #cd7f32; }
    .tier-badge.silver { background: #c0c0c0; color: #333; }
    .tier-badge.gold { background: #ffd700; color: #333; }
    .dealer-header-right { display: flex; align-items: center; gap: 16px; }
    .btn-logout {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    /* Navigation */
    .dealer-nav {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      z-index: 99;
      padding: 0 24px;
    }
    .nav-links { display: flex; gap: 8px; max-width: 1600px; margin: 0 auto; }
    .nav-link {
      padding: 16px 20px;
      color: #6b7280;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      border-bottom: 2px solid transparent;
    }
    .nav-link:hover { color: #2d5a27; }
    .nav-link.active { color: #2d5a27; border-bottom-color: #2d5a27; }

    /* Main Content */
    .dealer-main {
      margin-top: 120px;
      padding: 24px;
      max-width: 1600px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .page-title { font-size: 24px; font-weight: 700; color: #1a1a2e; }
    .btn-back {
      color: #6b7280;
      text-decoration: none;
      font-size: 14px;
    }
    .btn-back:hover { color: #2d5a27; }

    /* Info Box */
    .info-box {
      background: linear-gradient(135deg, #2d5a27 0%, #1a3a15 100%);
      color: white;
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    .info-box-text { font-size: 15px; }
    .info-box-text strong { color: #90EE90; }
    .discount-badge-large {
      background: rgba(255,255,255,0.2);
      padding: 8px 20px;
      border-radius: 24px;
      font-size: 18px;
      font-weight: 700;
    }

    /* Layout Grid */
    .order-layout {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }
    @media (max-width: 1200px) {
      .order-layout { grid-template-columns: 1fr; }
    }

    /* Form Cards */
    .form-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 24px;
      overflow: hidden;
    }
    .card-header {
      padding: 16px 24px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a1a2e;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title .step {
      background: #2d5a27;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }
    .card-body { padding: 24px; }

    /* Product Selection */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 16px;
    }
    .product-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .product-card:hover { border-color: #2d5a27; transform: translateY(-2px); }
    .product-card.selected { border-color: #2d5a27; background: #f0f9f0; }
    .product-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #f3f4f6;
    }
    .product-card .name { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
    .product-card .price { color: #2d5a27; font-weight: 600; font-size: 14px; }

    /* Customer Form */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    @media (max-width: 640px) {
      .form-row { grid-template-columns: 1fr; }
    }
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #1a1a2e;
      margin-bottom: 6px;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #2d5a27;
    }

    /* Dimensions */
    .dimension-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    .dimension-group { flex: 1; }
    .dimension-input-wrapper {
      display: flex;
      align-items: center;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }
    .dimension-input-wrapper input {
      flex: 1;
      padding: 12px;
      border: none;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
    }
    .dimension-input-wrapper input:focus { outline: none; }
    .dimension-input-wrapper .unit {
      padding: 12px;
      background: #f3f4f6;
      font-size: 14px;
      color: #6b7280;
    }

    /* Fabric Selection */
    .filter-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .filter-btn {
      padding: 10px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn:hover { border-color: #2d5a27; }
    .filter-btn.selected {
      border-color: #2d5a27;
      background: #2d5a27;
      color: white;
    }
    .fabric-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    .fabric-swatch {
      width: 80px;
      text-align: center;
      cursor: pointer;
      padding: 4px;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .fabric-swatch:hover { background: #f0f9f0; }
    .fabric-swatch.selected { background: #d1fae5; }
    .fabric-swatch img {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      object-fit: cover;
      border: 2px solid transparent;
    }
    .fabric-swatch.selected img { border-color: #2d5a27; }
    .fabric-swatch .code { font-size: 10px; color: #6b7280; margin-top: 4px; }

    /* Hardware Options */
    .hardware-section { margin-bottom: 20px; }
    .hardware-label {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a2e;
      margin-bottom: 10px;
      display: block;
    }
    .hardware-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .hardware-option {
      padding: 10px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      text-align: center;
      min-width: 100px;
      transition: all 0.2s;
    }
    .hardware-option:hover { border-color: #2d5a27; }
    .hardware-option.selected {
      border-color: #2d5a27;
      background: #f0f9f0;
    }
    .hardware-option .name { font-size: 13px; font-weight: 500; }
    .hardware-option .price { font-size: 11px; color: #2d5a27; margin-top: 2px; }

    /* Accessories */
    .accessory-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .accessory-option:hover { background: #f9fafb; }
    .accessory-option.selected { background: #f0f9f0; border-color: #2d5a27; }
    .accessory-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .accessory-option.selected .accessory-checkbox {
      background: #2d5a27;
      border-color: #2d5a27;
      color: white;
    }
    .accessory-info { flex: 1; }
    .accessory-name { font-weight: 500; font-size: 14px; }
    .accessory-desc { font-size: 12px; color: #6b7280; }
    .accessory-price { font-weight: 600; color: #2d5a27; }

    /* Order Summary Sidebar */
    .summary-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      position: sticky;
      top: 140px;
    }
    .summary-header {
      padding: 20px 24px;
      border-bottom: 1px solid #e5e7eb;
    }
    .summary-title { font-size: 18px; font-weight: 700; }
    .summary-body { padding: 24px; }
    .summary-product {
      display: flex;
      gap: 12px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f3f4f6;
      margin-bottom: 16px;
    }
    .summary-product img {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      background: #f3f4f6;
    }
    .summary-product-info { flex: 1; }
    .summary-product-name { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
    .summary-product-details { font-size: 12px; color: #6b7280; }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 14px;
    }
    .summary-row .label { color: #6b7280; }
    .summary-row .value { font-weight: 600; }
    .summary-row.discount .value { color: #10b981; }
    .summary-row.total {
      font-size: 18px;
      padding-top: 16px;
      margin-top: 8px;
      border-top: 2px solid #e5e7eb;
    }
    .summary-row.total .label { font-weight: 600; }
    .summary-row.total .value { color: #2d5a27; }

    /* Quantity */
    .quantity-control {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f3f4f6;
    }
    .quantity-label { font-size: 14px; font-weight: 500; }
    .quantity-buttons {
      display: flex;
      align-items: center;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
    }
    .qty-btn {
      width: 36px;
      height: 36px;
      border: none;
      background: #f3f4f6;
      font-size: 18px;
      cursor: pointer;
    }
    .qty-btn:hover { background: #e5e7eb; }
    .qty-value {
      width: 50px;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
    }

    /* Buttons */
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 24px;
    }
    .btn {
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      text-align: center;
      text-decoration: none;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #2d5a27;
      color: white;
      border: none;
    }
    .btn-primary:hover { background: #1a3a15; }
    .btn-primary:disabled { background: #9ca3af; cursor: not-allowed; }
    .btn-secondary {
      background: white;
      color: #1a1a2e;
      border: 1px solid #e5e7eb;
    }
    .btn-secondary:hover { background: #f3f4f6; }

    /* Loading */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top-color: #2d5a27;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header class="dealer-header">
    <div class="dealer-header-left">
      <img src="/images/logo-white.png" alt="Peekaboo Shades" onerror="this.src='/images/logo.png'">
      <h1>Dealer Portal</h1>
      <span id="tier-badge" class="tier-badge">Bronze</span>
    </div>
    <div class="dealer-header-right">
      <button class="btn-logout" onclick="logout()">Logout</button>
    </div>
  </header>

  <nav class="dealer-nav">
    <div class="nav-links">
      <a href="/dealer/" class="nav-link">Dashboard</a>
      <a href="/dealer/orders.html" class="nav-link active">Orders</a>
      <a href="/dealer/customers.html" class="nav-link">Customers</a>
      <a href="/dealer/commissions.html" class="nav-link">Commissions</a>
    </div>
  </nav>

  <main class="dealer-main">
    <div class="page-header">
      <h1 class="page-title">Create New Order</h1>
      <a href="/dealer/orders.html" class="btn-back">&larr; Back to Orders</a>
    </div>

    <div class="info-box">
      <div class="info-box-text">
        As a <strong id="tier-text">Bronze</strong> tier dealer, you receive exclusive wholesale pricing on all orders.
      </div>
      <div class="discount-badge-large" id="discount-badge">15% OFF</div>
    </div>

    <div class="order-layout">
      <div class="order-configurator">
        <!-- Step 1: Select Product -->
        <div class="form-card">
          <div class="card-header">
            <h3 class="card-title"><span class="step">1</span> Select Product</h3>
          </div>
          <div class="card-body">
            <div class="product-grid" id="product-grid">
              <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                <div class="loading-spinner"></div>
                <p style="margin-top: 12px; color: #6b7280;">Loading products...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Customer Info -->
        <div class="form-card">
          <div class="card-header">
            <h3 class="card-title"><span class="step">2</span> Customer Information</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Select Existing Customer</label>
              <select class="form-select" id="customer-select" onchange="selectCustomer(this.value)">
                <option value="">-- New Customer --</option>
              </select>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Customer Name *</label>
                <input type="text" class="form-input" id="customer-name" required>
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="customer-email">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-input" id="customer-phone">
              </div>
              <div class="form-group">
                <label class="form-label">Address</label>
                <input type="text" class="form-input" id="customer-address">
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Dimensions -->
        <div class="form-card">
          <div class="card-header">
            <h3 class="card-title"><span class="step">3</span> Dimensions</h3>
          </div>
          <div class="card-body">
            <div class="dimension-row">
              <div class="dimension-group">
                <label class="form-label">Width</label>
                <div class="dimension-input-wrapper">
                  <input type="number" id="width-input" value="24" min="12" max="120" step="0.125" onchange="calculatePrice()">
                  <span class="unit">in</span>
                </div>
              </div>
              <div class="dimension-group">
                <label class="form-label">Height</label>
                <div class="dimension-input-wrapper">
                  <input type="number" id="height-input" value="36" min="12" max="120" step="0.125" onchange="calculatePrice()">
                  <span class="unit">in</span>
                </div>
              </div>
            </div>
            <div style="background: #f0f9f0; padding: 12px; border-radius: 8px; font-size: 13px; color: #1a1a2e;">
              <strong>Area:</strong> <span id="area-display">6.00</span> sq ft
            </div>
          </div>
        </div>

        <!-- Step 4: Fabric -->
        <div class="form-card">
          <div class="card-header">
            <h3 class="card-title"><span class="step">4</span> Shade Style & Fabric</h3>
          </div>
          <div class="card-body">
            <div class="hardware-section">
              <span class="hardware-label">Fabric Category</span>
              <div class="filter-buttons" id="filter-buttons">
                <button type="button" class="filter-btn selected" data-value="blackout" onclick="selectFilter(this)">Blackout</button>
                <button type="button" class="filter-btn" data-value="semi-blackout" onclick="selectFilter(this)">Semi-Blackout</button>
                <button type="button" class="filter-btn" data-value="super-blackout" onclick="selectFilter(this)">Super Blackout</button>
                <button type="button" class="filter-btn" data-value="transparent" onclick="selectFilter(this)">Transparent</button>
              </div>
            </div>
            <div class="hardware-section">
              <span class="hardware-label">Fabric Color</span>
              <div class="fabric-grid" id="fabric-grid">
                <div style="width: 100%; text-align: center; padding: 20px;">
                  <div class="loading-spinner"></div>
                  <p style="margin-top: 12px; color: #6b7280;">Loading fabrics...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 5: Hardware Options -->
        <div class="form-card">
          <div class="card-header">
            <h3 class="card-title"><span class="step">5</span> Hardware Options</h3>
          </div>
          <div class="card-body">
            <div class="hardware-section">
              <span class="hardware-label">Mount Type</span>
              <div class="hardware-options" id="mount-options">
                <div class="hardware-option selected" data-value="inside" onclick="selectHardware(this, 'mount')">
                  <div class="name">Inside Mount</div>
                  <div class="price">Included</div>
                </div>
                <div class="hardware-option" data-value="outside" onclick="selectHardware(this, 'mount')">
                  <div class="name">Outside Mount</div>
                  <div class="price">Included</div>
                </div>
              </div>
            </div>

            <div class="hardware-section">
              <span class="hardware-label">Control Type</span>
              <div class="hardware-options" id="control-options">
                <div class="hardware-option selected" data-value="chain" data-price="0" onclick="selectHardware(this, 'control')">
                  <div class="name">Bead Chain</div>
                  <div class="price">Included</div>
                </div>
                <div class="hardware-option" data-value="cordless" data-price="0" onclick="selectHardware(this, 'control')">
                  <div class="name">Cordless</div>
                  <div class="price">Included</div>
                </div>
                <div class="hardware-option" data-value="motorized" data-price="0" onclick="selectHardware(this, 'control')">
                  <div class="name">Motorized</div>
                  <div class="price">+Motor Cost</div>
                </div>
              </div>
            </div>

            <div class="hardware-section" id="motor-section" style="display: none;">
              <span class="hardware-label">Motor Brand</span>
              <div class="hardware-options" id="motor-options">
                <div class="hardware-option selected" data-value="aok" onclick="selectHardware(this, 'motor')">
                  <div class="name">AOK Motor</div>
                  <div class="price">+$63.00</div>
                </div>
                <div class="hardware-option" data-value="dooya" onclick="selectHardware(this, 'motor')">
                  <div class="name">Dooya Motor</div>
                  <div class="price">+$65.80</div>
                </div>
              </div>
            </div>

            <div class="hardware-section" id="remote-section" style="display: none;">
              <span class="hardware-label">Remote Type</span>
              <div class="hardware-options" id="remote-options">
                <div class="hardware-option selected" data-value="single-channel" onclick="selectHardware(this, 'remote')">
                  <div class="name">Single Channel</div>
                  <div class="price">+$8.40</div>
                </div>
                <div class="hardware-option" data-value="6-channel" onclick="selectHardware(this, 'remote')">
                  <div class="name">6 Channel</div>
                  <div class="price">+$9.24</div>
                </div>
                <div class="hardware-option" data-value="15-channel" onclick="selectHardware(this, 'remote')">
                  <div class="name">15 Channel</div>
                  <div class="price">+$15.89</div>
                </div>
              </div>
            </div>

            <div class="hardware-section" id="solar-section" style="display: none;">
              <span class="hardware-label">Solar Panel</span>
              <div class="hardware-options" id="solar-options">
                <div class="hardware-option selected" data-value="no" onclick="selectHardware(this, 'solar')">
                  <div class="name">No Solar</div>
                  <div class="price">Included</div>
                </div>
                <div class="hardware-option" data-value="yes" onclick="selectHardware(this, 'solar')">
                  <div class="name">Add Solar Panel</div>
                  <div class="price">+$28.70</div>
                </div>
              </div>
            </div>

            <div class="hardware-section">
              <span class="hardware-label">Valance Type</span>
              <div class="hardware-options" id="valance-options">
                <div class="hardware-option selected" data-value="none" onclick="selectHardware(this, 'valance')">
                  <div class="name">No Valance</div>
                  <div class="price">Included</div>
                </div>
                <div class="hardware-option" data-value="fabric" onclick="selectHardware(this, 'valance')">
                  <div class="name">Fabric Wrapped</div>
                  <div class="price">+$3.08/m²</div>
                </div>
              </div>
            </div>

            <div class="hardware-section">
              <span class="hardware-label">Bottom Rail</span>
              <div class="hardware-options" id="rail-options">
                <div class="hardware-option selected" data-value="standard" onclick="selectHardware(this, 'rail')">
                  <div class="name">Standard</div>
                  <div class="price">Included</div>
                </div>
                <div class="hardware-option" data-value="fabric" onclick="selectHardware(this, 'rail')">
                  <div class="name">Fabric Wrapped</div>
                  <div class="price">+$3.08/m²</div>
                </div>
              </div>
            </div>

            <div class="hardware-section">
              <span class="hardware-label">Roller Type</span>
              <div class="hardware-options" id="roller-options">
                <div class="hardware-option selected" data-value="standard" data-price="0" onclick="selectHardware(this, 'roller')">
                  <div class="name">Standard Roll</div>
                  <div class="price">Included</div>
                </div>
                <div class="hardware-option" data-value="reverse" data-price="0" onclick="selectHardware(this, 'roller')">
                  <div class="name">Reverse Roll</div>
                  <div class="price">Free</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 6: Accessories -->
        <div class="form-card">
          <div class="card-header">
            <h3 class="card-title"><span class="step">6</span> Accessories</h3>
          </div>
          <div class="card-body">
            <div class="accessory-option" data-value="smart-hub" data-price="32.90" onclick="toggleAccessory(this)">
              <div class="accessory-checkbox"><i class="fas fa-check" style="display: none;"></i></div>
              <div class="accessory-info">
                <div class="accessory-name">Smart Hub</div>
                <div class="accessory-desc">WiFi bridge for app control</div>
              </div>
              <div class="accessory-price">+$32.90</div>
            </div>
            <div class="accessory-option" data-value="usb-charger" data-price="7" onclick="toggleAccessory(this)">
              <div class="accessory-checkbox"><i class="fas fa-check" style="display: none;"></i></div>
              <div class="accessory-info">
                <div class="accessory-name">USB Charger</div>
                <div class="accessory-desc">For rechargeable motors</div>
              </div>
              <div class="accessory-price">+$7.00</div>
            </div>
          </div>
        </div>

        <!-- Step 7: Notes -->
        <div class="form-card">
          <div class="card-header">
            <h3 class="card-title"><span class="step">7</span> Order Notes</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Special Instructions (optional)</label>
              <textarea class="form-input" id="order-notes" rows="3" placeholder="Any special instructions for manufacturing or shipping..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Summary Sidebar -->
      <div class="order-sidebar">
        <div class="summary-card">
          <div class="summary-header">
            <h3 class="summary-title">Order Summary</h3>
          </div>
          <div class="summary-body">
            <div class="summary-product" id="summary-product">
              <img src="/images/placeholder.jpg" alt="Product" id="summary-img">
              <div class="summary-product-info">
                <div class="summary-product-name" id="summary-name">Select a product</div>
                <div class="summary-product-details" id="summary-details">--</div>
              </div>
            </div>

            <div class="summary-row">
              <span class="label">Base Price</span>
              <span class="value" id="summary-base">$0.00</span>
            </div>
            <div class="summary-row">
              <span class="label">Fabric</span>
              <span class="value" id="summary-fabric">$0.00</span>
            </div>
            <div class="summary-row">
              <span class="label">Hardware</span>
              <span class="value" id="summary-hardware">$0.00</span>
            </div>
            <div class="summary-row">
              <span class="label">Accessories</span>
              <span class="value" id="summary-accessories">$0.00</span>
            </div>
            <div class="summary-row">
              <span class="label">Retail Subtotal</span>
              <span class="value" id="summary-subtotal">$0.00</span>
            </div>
            <div class="summary-row discount">
              <span class="label">Dealer Discount (<span id="discount-percent">15</span>%)</span>
              <span class="value" id="summary-discount">-$0.00</span>
            </div>
            <div class="summary-row total">
              <span class="label">Your Price</span>
              <span class="value" id="summary-total">$0.00</span>
            </div>

            <div class="quantity-control">
              <span class="quantity-label">Quantity:</span>
              <div class="quantity-buttons">
                <button type="button" class="qty-btn" onclick="changeQty(-1)">-</button>
                <span class="qty-value" id="qty-value">1</span>
                <button type="button" class="qty-btn" onclick="changeQty(1)">+</button>
              </div>
            </div>

            <div class="btn-group">
              <button type="button" class="btn btn-primary" id="btn-add-cart" onclick="addToCart()">
                Add to Cart
              </button>
              <button type="button" class="btn btn-secondary" onclick="saveQuote()">
                Save as Quote
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Check authentication
    const token = localStorage.getItem('dealerToken');
    const user = JSON.parse(localStorage.getItem('dealerUser') || '{}');

    if (!token) {
      window.location.href = '/dealer/login.html';
    }

    // Configuration - get tier from user.dealer object
    let discountPercent = 15;
    const discounts = { bronze: 15, silver: 20, gold: 25 };
    const dealerInfo = user.dealer || {};
    const tier = dealerInfo.tier || 'bronze';

    discountPercent = discounts[tier.toLowerCase()] || dealerInfo.discountPercent || 15;
    document.getElementById('tier-badge').textContent = tier.charAt(0).toUpperCase() + tier.slice(1);
    document.getElementById('tier-badge').classList.add(tier.toLowerCase());
    document.getElementById('tier-text').textContent = tier.charAt(0).toUpperCase() + tier.slice(1);
    document.getElementById('discount-badge').textContent = discountPercent + '% OFF';
    document.getElementById('discount-percent').textContent = discountPercent;

    console.log('Dealer portal initialized. User:', user.name, 'Tier:', tier, 'Discount:', discountPercent + '%');

    // State
    let products = [];
    let customers = [];
    let selectedProduct = null;
    let selectedFabric = null;
    let quantity = 1;
    let currentPricing = null; // Store current pricing from API
    let selections = {
      mount: 'inside',
      control: 'chain',
      motor: 'aok',
      remote: 'single-channel',
      solar: 'no',
      valance: 'none',
      rail: 'standard',
      roller: 'standard'
    };
    let accessories = [];

    // Map product slugs to product types that have pricing
    const productTypeMap = {
      'affordable-custom-roller-blinds': 'roller',
      'roller-shades': 'roller',
      'roller-blinds': 'roller',
      'affordable-zebra-window-blinds': 'zebra',
      'zebra-shades': 'zebra',
      'zebra-blinds': 'zebra'
    };

    // Get product type from slug
    function getProductType(slug) {
      // Direct match
      if (productTypeMap[slug]) return productTypeMap[slug];
      // Check if slug contains keyword
      if (slug.includes('roller')) return 'roller';
      if (slug.includes('zebra')) return 'zebra';
      return null;
    }

    // Load products - only show products that have pricing configured
    async function loadProducts() {
      try {
        const response = await fetch('/api/products');
        const result = await response.json();
        const allProducts = result.data || result;

        // Filter to only products with pricing (roller and zebra)
        products = allProducts.filter(p => {
          const productType = getProductType(p.slug);
          return productType !== null; // Only include products we can price
        });

        const grid = document.getElementById('product-grid');
        if (products.length === 0) {
          grid.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
              <p>No products with pricing available.</p>
              <p style="font-size: 12px; margin-top: 8px;">Contact admin to configure product pricing.</p>
            </div>
          `;
          return;
        }

        grid.innerHTML = products.map(p => {
          const productType = getProductType(p.slug);
          return `
            <div class="product-card" data-id="${p.id}" data-type="${productType}" onclick="selectProduct('${p.id}')">
              <img src="${p.images?.[0] || '/images/placeholder.jpg'}" alt="${p.name}" onerror="this.src='/images/placeholder.jpg'">
              <div class="name">${p.name}</div>
              <div class="price">Custom Pricing</div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('product-grid').innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #dc2626;">
            <p>Failed to load products. Please refresh the page.</p>
          </div>
        `;
      }
    }

    // Load customers
    async function loadCustomers() {
      try {
        const response = await fetch('/api/dealer/customers', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const result = await response.json();
        customers = result.data || [];

        const select = document.getElementById('customer-select');
        select.innerHTML = '<option value="">-- New Customer --</option>' +
          customers.map(c => `<option value="${c.id}">${c.name} (${c.email || 'No email'})</option>`).join('');
      } catch (error) {
        console.error('Error loading customers:', error);
      }
    }

    // Select product
    async function selectProduct(productId) {
      selectedProduct = products.find(p => p.id === productId);

      // Update UI
      document.querySelectorAll('.product-card').forEach(card => {
        card.classList.toggle('selected', card.dataset.id === productId);
      });

      // Update summary
      document.getElementById('summary-name').textContent = selectedProduct.name;
      document.getElementById('summary-img').src = selectedProduct.images?.[0] || '/images/placeholder.jpg';

      // Load fabrics
      await loadFabrics(selectedProduct.slug || selectedProduct.id);

      calculatePrice();
    }

    // All fabrics data (loaded once)
    let allFabricsData = [];

    // Load all fabrics with pricing from manufacturer prices
    async function loadAllFabrics() {
      const grid = document.getElementById('fabric-grid');
      console.log('loadAllFabrics called. Token exists:', !!token);

      try {
        // Get dealer pricing which includes fabrics with customer prices
        console.log('Fetching /api/dealer/pricing...');
        const response = await fetch('/api/dealer/pricing', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        console.log('API response status:', response.status);

        if (!response.ok) {
          console.error('Dealer pricing API error:', response.status, response.statusText);

          // If 401 error, show re-login link (don't auto-redirect)
          if (response.status === 401) {
            grid.innerHTML = `<p style="color: #dc2626; width: 100%; text-align: center; padding: 20px;">Session expired. Please <a href="/dealer/login.html" style="color: #2d5a27; text-decoration: underline;">login again</a>.</p>`;
            allFabricsData = [];
            return;
          }

          grid.innerHTML = `<p style="color: #dc2626; width: 100%; text-align: center; padding: 20px;">Failed to load fabrics. Please refresh the page.</p>`;
          allFabricsData = [];
          return;
        }

        const result = await response.json();
        console.log('Dealer pricing response:', result.success, 'fabrics:', result.data?.fabrics?.length);

        if (result.success && result.data && result.data.fabrics && result.data.fabrics.length > 0) {
          allFabricsData = result.data.fabrics;
          console.log('Loaded', allFabricsData.length, 'fabrics with pricing');
          // Log categories for debugging
          const cats = {};
          allFabricsData.forEach(f => { cats[f.category] = (cats[f.category] || 0) + 1; });
          console.log('Fabric categories:', cats);
        } else if (result.success && result.fabrics && result.fabrics.length > 0) {
          allFabricsData = result.fabrics;
          console.log('Loaded', allFabricsData.length, 'fabrics (direct)');
        } else {
          console.warn('No fabrics found in dealer pricing response:', result);
          grid.innerHTML = `<p style="color: #f59e0b; width: 100%; text-align: center; padding: 20px;">No fabric pricing configured. Please contact admin.</p>`;
          allFabricsData = [];
        }
      } catch (error) {
        console.error('Error loading fabrics:', error);
        grid.innerHTML = `<p style="color: #dc2626; width: 100%; text-align: center; padding: 20px;">Error loading fabrics: ${error.message}</p>`;
        allFabricsData = [];
      }
    }

    // Load fabrics for product (filter by category)
    async function loadFabrics(slug) {
      // Load all fabrics if not loaded yet
      if (allFabricsData.length === 0) {
        await loadAllFabrics();
      }

      // Get selected filter
      const selectedFilter = document.querySelector('.filter-btn.selected');
      const filterType = selectedFilter ? selectedFilter.dataset.value : 'blackout';

      loadFabricsForFilter(filterType);
    }

    // Select fabric
    function selectFabric(el) {
      document.querySelectorAll('.fabric-swatch').forEach(s => s.classList.remove('selected'));
      el.classList.add('selected');
      selectedFabric = {
        code: el.dataset.code
      };
      calculatePrice(); // Will use API for pricing
    }

    // Select filter
    function selectFilter(btn) {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      // Reload fabrics for this filter type
      const filterType = btn.dataset.value;
      loadFabricsForFilter(filterType);
    }

    async function loadFabricsForFilter(filterType) {
      const grid = document.getElementById('fabric-grid');

      // Show loading state
      grid.innerHTML = `
        <div style="width: 100%; text-align: center; padding: 20px;">
          <div class="loading-spinner"></div>
          <p style="margin-top: 12px; color: #6b7280;">Loading ${filterType} fabrics...</p>
        </div>
      `;

      // Load all fabrics if not loaded yet
      if (allFabricsData.length === 0) {
        await loadAllFabrics();
      }

      // If still no fabrics (loading failed), the error message is already shown
      if (allFabricsData.length === 0) {
        return;
      }

      // Map filter button values to fabric categories
      const categoryMap = {
        'light-filtering': 'transparent',
        'blackout': 'blackout',
        'semi-blackout': 'semi-blackout',
        'super-blackout': 'super-blackout',
        'transparent': 'transparent'
      };

      const category = categoryMap[filterType] || filterType;

      // Filter fabrics by category (case-insensitive match)
      const filteredFabrics = allFabricsData.filter(f => {
        const fabricCategory = (f.category || '').toLowerCase();
        const searchCategory = category.toLowerCase();
        return fabricCategory === searchCategory || fabricCategory.includes(searchCategory);
      });

      console.log(`Filtering ${filterType} (${category}): found ${filteredFabrics.length} fabrics`);

      if (filteredFabrics.length > 0) {
        grid.innerHTML = filteredFabrics.slice(0, 50).map(f => {
          const price = typeof f.customerPrice === 'number' ? f.customerPrice.toFixed(2) : (f.customerPrice || '0.00');
          return `
            <div class="fabric-swatch" data-code="${f.code}" data-price="${f.customerPrice || 0}" onclick="selectFabric(this)">
              <img src="${f.image || '/images/fabrics/' + f.code + '.jpg'}" alt="${f.code}" onerror="this.src='/images/placeholder.jpg'">
              <div class="code">${f.code}</div>
              <div class="price" style="font-size: 9px; color: #2d5a27; font-weight: 600;">$${price}/m²</div>
            </div>
          `;
        }).join('');

        // Select first fabric (but don't calculate price yet if no product selected)
        const first = grid.querySelector('.fabric-swatch');
        if (first) {
          first.classList.add('selected');
          selectedFabric = { code: first.dataset.code };
          // Only calculate price if product is selected
          if (selectedProduct) {
            calculatePrice();
          }
        }
      } else {
        // Show which categories have fabrics
        const categoryCounts = {};
        allFabricsData.forEach(f => {
          const cat = f.category || 'unknown';
          categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
        });
        console.log('Available categories:', categoryCounts);
        grid.innerHTML = `<p style="color: #6b7280; width: 100%; text-align: center; padding: 20px;">No ${filterType} fabrics available. Try another category.</p>`;
      }
    }

    // Select hardware option
    function selectHardware(el, type) {
      const container = el.parentElement;
      container.querySelectorAll('.hardware-option').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      selections[type] = el.dataset.value;

      // Show/hide motorized options (motor brand, remote type, solar panel)
      if (type === 'control') {
        const isMotorized = el.dataset.value === 'motorized';
        document.getElementById('motor-section').style.display = isMotorized ? 'block' : 'none';
        document.getElementById('remote-section').style.display = isMotorized ? 'block' : 'none';
        document.getElementById('solar-section').style.display = isMotorized ? 'block' : 'none';
      }

      calculatePrice();
    }

    // Toggle accessory
    function toggleAccessory(el) {
      el.classList.toggle('selected');
      const icon = el.querySelector('.fa-check');
      icon.style.display = el.classList.contains('selected') ? 'block' : 'none';

      const value = el.dataset.value;
      if (el.classList.contains('selected')) {
        accessories.push({ value, price: parseFloat(el.dataset.price) });
      } else {
        accessories = accessories.filter(a => a.value !== value);
      }

      calculatePrice();
    }

    // Select customer
    function selectCustomer(customerId) {
      const customer = customers.find(c => c.id === customerId);
      if (customer) {
        document.getElementById('customer-name').value = customer.name || '';
        document.getElementById('customer-email').value = customer.email || '';
        document.getElementById('customer-phone').value = customer.phone || '';
        document.getElementById('customer-address').value = customer.address || '';
      } else {
        document.getElementById('customer-name').value = '';
        document.getElementById('customer-email').value = '';
        document.getElementById('customer-phone').value = '';
        document.getElementById('customer-address').value = '';
      }
    }

    // Change quantity
    function changeQty(delta) {
      quantity = Math.max(1, quantity + delta);
      document.getElementById('qty-value').textContent = quantity;
      calculatePrice();
    }

    // Calculate price using customer pricing API
    async function calculatePrice() {
      console.log('calculatePrice called. Product:', selectedProduct?.name, 'Fabric:', selectedFabric?.code);

      const width = parseFloat(document.getElementById('width-input').value) || 24;
      const height = parseFloat(document.getElementById('height-input').value) || 36;

      // Area in sq ft
      const sqFt = (width * height) / 144;

      document.getElementById('area-display').textContent = sqFt.toFixed(2);
      document.getElementById('summary-details').textContent = `${width}" x ${height}" | Qty: ${quantity}`;

      // If no product or fabric selected, show placeholder
      if (!selectedProduct || !selectedFabric) {
        console.log('Skipping price calc - Product selected:', !!selectedProduct, 'Fabric selected:', !!selectedFabric);
        resetPriceSummary();
        return;
      }

      // Get product type from slug
      const productType = getProductType(selectedProduct.slug);
      if (!productType) {
        console.error('Unknown product type for:', selectedProduct.slug);
        resetPriceSummary();
        return;
      }

      console.log('Calculating price for:', productType, selectedFabric.code, width, 'x', height);

      // Build options for pricing API
      const options = {
        controlType: selections.control === 'motorized' ? 'motorized' : 'manual',
        mountType: selections.mount,
        valanceType: selections.valance === 'fabric' ? 'fabric-wrapped-v3' : 'standard',
        bottomRail: selections.rail === 'fabric' ? 'type-c-fabric-wrapped' : 'standard'
      };

      // Add motor options if motorized
      if (selections.control === 'motorized') {
        options.motorBrand = selections.motor;
        options.motorType = 'battery';
        options.remoteType = selections.remote;
        options.solarType = selections.solar;
      }

      // Add accessories
      const smartHubQty = accessories.filter(a => a.value === 'smart-hub').length;
      const usbChargerQty = accessories.filter(a => a.value === 'usb-charger').length;
      if (smartHubQty > 0) options.smartHubQty = smartHubQty;
      if (usbChargerQty > 0) options.usbChargerQty = usbChargerQty;

      try {
        const response = await fetch('/api/store/price-quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            productSlug: selectedProduct.slug,
            productType: productType,
            width,
            height,
            quantity,
            fabricCode: selectedFabric.code,
            options
          })
        });

        const result = await response.json();
        console.log('Price API response:', result);

        if (result.success && result.data) {
          currentPricing = result.data;
          console.log('Pricing data:', result.data);
          updatePriceSummary(result.data);
        } else {
          console.error('Price calculation failed:', result.error);
          resetPriceSummary();
        }
      } catch (error) {
        console.error('Failed to calculate price:', error);
        resetPriceSummary();
      }
    }

    // Update price summary from API response
    function updatePriceSummary(pricing) {
      console.log('updatePriceSummary called with:', pricing);
      const formatCurrency = (val) => '$' + (val || 0).toFixed(2);

      // API response structure:
      // pricing.manufacturerPrice = MFR cost per unit
      // pricing.marginAmount = margin amount per unit
      // pricing.optionsCost = total options cost
      // pricing.unitPrice = customer price per unit (MFR + margin + options)
      // pricing.lineTotal = customer price × quantity

      // Base fabric customer price (MFR cost + margin)
      const mfrCost = pricing.manufacturerPrice || 0;
      const marginAmount = pricing.marginAmount || 0;
      const baseFabricCustomerPrice = mfrCost + marginAmount;

      // Options cost (hardware, motor, etc.)
      const optionsCost = pricing.optionsCost || 0;

      // Accessories cost
      const accessoriesCost = pricing.accessoriesCost || 0;

      // Customer price (before dealer discount)
      const lineTotal = pricing.lineTotal || 0;

      // Apply dealer discount on customer price
      const discount = lineTotal * (discountPercent / 100);
      const dealerPrice = lineTotal - discount;

      // Update summary - all values are CUSTOMER prices
      document.getElementById('summary-base').textContent = formatCurrency(baseFabricCustomerPrice * quantity);
      document.getElementById('summary-fabric').textContent = formatCurrency(0); // Included in base
      document.getElementById('summary-hardware').textContent = formatCurrency(optionsCost * quantity);
      document.getElementById('summary-accessories').textContent = formatCurrency(accessoriesCost * quantity);
      document.getElementById('summary-subtotal').textContent = formatCurrency(lineTotal);
      document.getElementById('summary-discount').textContent = '-' + formatCurrency(discount);
      document.getElementById('summary-total').textContent = formatCurrency(dealerPrice);
    }

    // Reset price summary to zeros
    function resetPriceSummary() {
      document.getElementById('summary-base').textContent = '$0.00';
      document.getElementById('summary-fabric').textContent = '$0.00';
      document.getElementById('summary-hardware').textContent = '$0.00';
      document.getElementById('summary-accessories').textContent = '$0.00';
      document.getElementById('summary-subtotal').textContent = '$0.00';
      document.getElementById('summary-discount').textContent = '-$0.00';
      document.getElementById('summary-total').textContent = '$0.00';
      currentPricing = null;
    }

    // Add to cart
    async function addToCart() {
      if (!selectedProduct) {
        alert('Please select a product');
        return;
      }

      if (!selectedFabric) {
        alert('Please select a fabric');
        return;
      }

      const customerName = document.getElementById('customer-name').value;
      if (!customerName) {
        alert('Please enter customer name');
        return;
      }

      if (!currentPricing) {
        alert('Please wait for price calculation to complete');
        return;
      }

      const width = parseFloat(document.getElementById('width-input').value);
      const height = parseFloat(document.getElementById('height-input').value);

      // Calculate dealer price from customer price
      const customerLineTotal = currentPricing.lineTotal || 0;
      const customerUnitPrice = currentPricing.unitPrice || 0;

      // Build order data in format backend expects
      const orderData = {
        // Customer info at root level
        customerName: customerName,
        customerEmail: document.getElementById('customer-email').value,
        customerPhone: document.getElementById('customer-phone').value,
        customerAddress: document.getElementById('customer-address').value,
        // Items array
        items: [{
          productId: selectedProduct.id,
          productName: selectedProduct.name,
          fabricCode: selectedFabric.code,
          width: width,
          height: height,
          quantity: quantity,
          price: customerUnitPrice, // Customer unit price
          options: {
            ...selections,
            productType: getProductType(selectedProduct.slug),
            // Include motor details if motorized
            ...(selections.control === 'motorized' && {
              motorBrand: selections.motor,
              remoteType: selections.remote,
              solarPanel: selections.solar
            }),
            // Include accessories
            accessories: accessories.map(a => a.value)
          },
          // Include pricing snapshot for reference
          pricingSnapshot: {
            manufacturerPrice: currentPricing.manufacturerPrice,
            marginAmount: currentPricing.marginAmount,
            optionsCost: currentPricing.optionsCost,
            accessoriesCost: currentPricing.accessoriesCost || 0,
            customerUnitPrice: customerUnitPrice,
            customerLineTotal: customerLineTotal
          }
        }],
        notes: document.getElementById('order-notes').value,
        status: 'pending'
      };

      console.log('Creating dealer order:', orderData);

      try {
        const response = await fetch('/api/dealer/orders', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(orderData)
        });

        const result = await response.json();
        console.log('Order creation response:', result);

        if (result.success) {
          alert('Order created successfully! Order #: ' + (result.data.orderNumber || result.data.id));
          window.location.href = '/dealer/orders.html';
        } else {
          alert(result.error || 'Failed to create order');
        }
      } catch (error) {
        console.error('Error creating order:', error);
        alert('Unable to create order. Please try again.');
      }
    }

    // Save as quote
    async function saveQuote() {
      if (!selectedProduct) {
        alert('Please select a product');
        return;
      }

      if (!selectedFabric) {
        alert('Please select a fabric');
        return;
      }

      const customerName = document.getElementById('customer-name').value;
      if (!customerName) {
        alert('Please enter customer name');
        return;
      }

      if (!currentPricing) {
        alert('Please wait for price calculation to complete');
        return;
      }

      const width = parseFloat(document.getElementById('width-input').value);
      const height = parseFloat(document.getElementById('height-input').value);
      const customerUnitPrice = currentPricing.unitPrice || 0;
      const customerLineTotal = currentPricing.lineTotal || 0;

      // Build quote data
      const quoteData = {
        customer: {
          name: customerName,
          email: document.getElementById('customer-email').value,
          phone: document.getElementById('customer-phone').value,
          address: document.getElementById('customer-address').value
        },
        items: [{
          productId: selectedProduct.id,
          productName: selectedProduct.name,
          fabricCode: selectedFabric.code,
          width: width,
          height: height,
          quantity: quantity,
          unitPrice: customerUnitPrice,
          lineTotal: customerLineTotal,
          configuration: JSON.stringify({
            ...selections,
            productType: getProductType(selectedProduct.slug),
            ...(selections.control === 'motorized' && {
              motorBrand: selections.motor,
              remoteType: selections.remote,
              solarPanel: selections.solar
            }),
            accessories: accessories.map(a => a.value)
          })
        }],
        notes: document.getElementById('order-notes').value,
        source: 'dealer_portal',
        dealerId: user.dealer?.id || user.dealerId
      };

      console.log('Creating quote:', quoteData);

      try {
        const response = await fetch('/api/quotes', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(quoteData)
        });

        const result = await response.json();
        console.log('Quote creation response:', result);

        if (result.success) {
          alert('Quote saved successfully! Quote #: ' + (result.data.quoteNumber || result.data.id));
          // Optionally redirect or stay on page
          if (confirm('View quote details?')) {
            window.location.href = '/dealer/orders.html?tab=quotes';
          }
        } else {
          alert(result.error || 'Failed to save quote');
        }
      } catch (error) {
        console.error('Error saving quote:', error);
        alert('Unable to save quote. Please try again.');
      }
    }

    // Helper
    function formatCurrency(amount) {
      return '$' + (amount || 0).toFixed(2);
    }

    function logout() {
      localStorage.removeItem('dealerToken');
      localStorage.removeItem('dealerUser');
      window.location.href = '/dealer/login.html';
    }

    // Initialize
    async function init() {
      console.log('=== Dealer Portal Initialization Started ===');

      try {
        // Load products and customers in parallel
        console.log('Loading products and customers...');
        await Promise.all([loadProducts(), loadCustomers()]);
        console.log('Products loaded:', products.length, 'Customers loaded:', customers.length);

        // Pre-load fabrics with pricing
        console.log('Loading fabrics...');
        await loadAllFabrics();
        console.log('Fabrics loaded:', allFabricsData.length);

        // Start with zeroed pricing until product/fabric selected
        resetPriceSummary();

        // Show fabrics grid with default category (blackout)
        // If blackout has no fabrics, try other categories
        if (allFabricsData.length > 0) {
          const categories = ['blackout', 'semi-blackout', 'super-blackout', 'transparent'];
          let foundCategory = null;

          for (const cat of categories) {
            const count = allFabricsData.filter(f =>
              (f.category || '').toLowerCase() === cat.toLowerCase()
            ).length;
            console.log('Category', cat, 'has', count, 'fabrics');
            if (count > 0 && !foundCategory) {
              foundCategory = cat;
            }
          }

          if (foundCategory) {
            console.log('Showing category:', foundCategory);
            // Update the selected filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
              btn.classList.toggle('selected', btn.dataset.value === foundCategory);
            });
            await loadFabricsForFilter(foundCategory);
          }

          console.log('=== Initialization Complete ===');
        } else {
          console.warn('=== No fabrics loaded during initialization ===');
        }
      } catch (error) {
        console.error('=== Initialization Error ===', error);
      }
    }
    init();
  </script>
</body>
</html>
