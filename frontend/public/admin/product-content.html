<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Content - Peekaboo Shades Admin</title>
  <link rel="stylesheet" href="css/admin.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <style>
    .product-content-layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 24px;
    }

    @media (max-width: 1200px) {
      .product-content-layout {
        grid-template-columns: 1fr;
      }
    }

    .content-section {
      background: var(--admin-card);
      border: 1px solid var(--admin-border);
      border-radius: 12px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--admin-border);
      background: #f9fafb;
      cursor: pointer;
      user-select: none;
    }

    .section-header:hover {
      background: #f3f4f6;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #1a1a1a;
    }

    .section-title i {
      color: #8E6545;
      width: 20px;
    }

    .section-toggle {
      transition: transform 0.2s;
      color: #888;
    }

    .section-header.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .section-body {
      padding: 20px;
    }

    .section-body.collapsed {
      display: none;
    }

    /* Preview Card */
    .preview-card {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      border-radius: 12px;
      padding: 20px;
      color: white;
      position: sticky;
      top: 24px;
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .preview-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .preview-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.1);
      color: white;
      text-decoration: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 13px;
      transition: background 0.2s;
    }

    .preview-link:hover {
      background: rgba(255,255,255,0.2);
    }

    .preview-iframe-container {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .preview-iframe {
      width: 100%;
      height: 400px;
      border: none;
      transform: scale(0.5);
      transform-origin: top left;
      width: 200%;
      height: 800px;
    }

    .preview-info {
      font-size: 12px;
      color: rgba(255,255,255,0.6);
      text-align: center;
    }

    /* Form Styles */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }

    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: #8E6545;
      box-shadow: 0 0 0 3px rgba(142, 101, 69, 0.1);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-help {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* Image Upload */
    .image-upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
    }

    .image-upload-card {
      border: 2px dashed #d1d5db;
      border-radius: 10px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
    }

    .image-upload-card:hover {
      border-color: #8E6545;
      background: #fdf8f5;
    }

    .image-upload-card.has-image {
      border-style: solid;
      border-color: #e5e7eb;
    }

    .image-preview {
      width: 100%;
      height: 100px;
      background: #f3f4f6;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
      overflow: hidden;
      position: relative;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .image-preview .upload-icon {
      font-size: 24px;
      color: #9ca3af;
    }

    .image-label {
      font-size: 12px;
      font-weight: 500;
      color: #6b7280;
    }

    .remove-image-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 22px;
      height: 22px;
      background: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .image-upload-card:hover .remove-image-btn {
      opacity: 1;
    }

    /* Feature/Badge Items */
    .items-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .item-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .item-row .drag-handle {
      color: #9ca3af;
      cursor: grab;
    }

    .item-row .icon-select {
      width: 100px;
    }

    .item-row .text-input {
      flex: 1;
    }

    .item-row .remove-btn {
      width: 30px;
      height: 30px;
      background: transparent;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .item-row .remove-btn:hover {
      background: #fee2e2;
      color: #dc2626;
    }

    .add-item-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      background: #f3f4f6;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      color: #6b7280;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-item-btn:hover {
      border-color: #8E6545;
      color: #8E6545;
      background: #fdf8f5;
    }

    /* Tags */
    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #e5e7eb;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
    }

    .tag .remove-tag {
      width: 16px;
      height: 16px;
      background: #9ca3af;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .tag .remove-tag:hover {
      background: #dc2626;
    }

    /* Action Buttons */
    .section-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #8E6545;
      color: white;
      border: none;
    }

    .btn-primary:hover {
      background: #7a5539;
    }

    .btn-secondary {
      background: white;
      color: #374151;
      border: 1px solid #d1d5db;
    }

    .btn-secondary:hover {
      background: #f9fafb;
    }

    /* Product Selector */
    .product-selector {
      background: linear-gradient(135deg, #8E6545 0%, #a67c5b 100%);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      color: white;
    }

    .product-selector-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .product-selector-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }

    .product-selector-dropdown {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      padding: 12px 16px;
      color: white;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
    }

    .product-selector-dropdown option {
      color: #1a1a1a;
    }

    /* Save All Banner */
    .save-banner {
      position: fixed;
      bottom: 0;
      left: 280px;
      right: 0;
      background: #1a1a1a;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
      transform: translateY(100%);
      transition: transform 0.3s;
    }

    .save-banner.visible {
      transform: translateY(0);
    }

    .save-banner-text {
      color: white;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .save-banner-actions {
      display: flex;
      gap: 12px;
    }

    .save-banner .btn-save {
      background: #22c55e;
      color: white;
      border: none;
      padding: 10px 24px;
    }

    .save-banner .btn-save:hover {
      background: #16a34a;
    }

    .save-banner .btn-discard {
      background: transparent;
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
    }

    @media (max-width: 768px) {
      .save-banner {
        left: 0;
      }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <a href="/admin/" class="sidebar-logo">
          <img src="/images/logo.png" alt="Logo" onerror="this.style.display='none'">
          <span>Peekaboo Shades</span>
        </a>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <a href="/admin/" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            <span>Dashboard</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Catalog</div>
          <a href="/admin/products.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <span>Products</span>
          </a>
          <a href="/admin/fabrics.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span>Fabrics</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Content</div>
          <a href="/admin/product-content.html" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            <span>Product Content</span>
          </a>
          <a href="/admin/product-page-editor.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6z" />
            </svg>
            <span>Page Editor</span>
          </a>
          <a href="/admin/faqs.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>FAQs</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Settings</div>
          <a href="/admin/settings.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span>Settings</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <!-- Header -->
      <header class="admin-header">
        <div class="header-left">
          <div class="breadcrumb">
            <a href="/admin/">Dashboard</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">Product Content</span>
          </div>
        </div>
        <div class="header-right">
          <a href="/product/affordable-custom-roller-blinds" target="_blank" class="btn btn-secondary" style="margin-right: 12px;">
            <i class="fas fa-external-link-alt"></i> View Live Page
          </a>
          <div class="dropdown">
            <div class="header-profile">
              <div class="profile-avatar">A</div>
              <span class="profile-name">Admin</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Page Content -->
      <div class="admin-content">
        <div class="page-header" style="margin-bottom: 24px;">
          <h1 class="page-title">Product Content</h1>
          <p style="color: #6b7280; margin-top: 4px;">Manage content for your product pages</p>
        </div>

        <!-- Product Selector -->
        <div class="product-selector">
          <div class="product-selector-header">
            <span class="product-selector-title">Editing Product</span>
            <a href="/admin/product-page-editor.html" style="color: white; font-size: 13px; opacity: 0.8;">
              <i class="fas fa-wand-magic-sparkles"></i> Open Page Editor
            </a>
          </div>
          <select class="product-selector-dropdown" id="productSelector" onchange="loadProductContent()">
            <!-- Products will be loaded here -->
          </select>
        </div>

        <div class="product-content-layout">
          <!-- Left Column - Content Sections -->
          <div class="content-column">
            <!-- Product Info Section -->
            <div class="content-section" id="info-section">
              <div class="section-header" onclick="toggleSection('info')">
                <h2 class="section-title">
                  <i class="fas fa-info-circle"></i>
                  Product Information
                </h2>
                <i class="fas fa-chevron-down section-toggle"></i>
              </div>
              <div class="section-body" id="info-body">
                <div class="form-group">
                  <label class="form-label">Product Title</label>
                  <input type="text" class="form-input" id="productTitle" placeholder="Enter product title" onchange="markUnsaved()">
                </div>
                <div class="form-group">
                  <label class="form-label">Short Description</label>
                  <textarea class="form-textarea" id="productDescription" placeholder="Enter product description" onchange="markUnsaved()"></textarea>
                  <p class="form-help">This appears below the title on the product page</p>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Base Price ($)</label>
                    <input type="number" class="form-input" id="productPrice" step="0.01" placeholder="0.00" onchange="markUnsaved()">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Sale Price ($)</label>
                    <input type="number" class="form-input" id="productSalePrice" step="0.01" placeholder="Leave empty for no sale" onchange="markUnsaved()">
                  </div>
                </div>
                <div class="section-actions">
                  <button class="btn btn-primary" onclick="saveProductInfo()">
                    <i class="fas fa-save"></i> Save Info
                  </button>
                </div>
              </div>
            </div>

            <!-- Gallery Images Section -->
            <div class="content-section" id="gallery-section">
              <div class="section-header" onclick="toggleSection('gallery')">
                <h2 class="section-title">
                  <i class="fas fa-images"></i>
                  Product Gallery
                </h2>
                <i class="fas fa-chevron-down section-toggle"></i>
              </div>
              <div class="section-body" id="gallery-body">
                <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">
                  Upload images that will display in the product gallery. The first image will be the main product image.
                </p>
                <div class="image-upload-grid" id="galleryGrid">
                  <!-- Images will be rendered here -->
                </div>
                <div class="section-actions">
                  <button class="btn btn-primary" onclick="saveGallery()">
                    <i class="fas fa-save"></i> Save Gallery
                  </button>
                </div>
              </div>
            </div>

            <!-- Features Section -->
            <div class="content-section" id="features-section">
              <div class="section-header" onclick="toggleSection('features')">
                <h2 class="section-title">
                  <i class="fas fa-list-check"></i>
                  Product Features
                </h2>
                <i class="fas fa-chevron-down section-toggle"></i>
              </div>
              <div class="section-body" id="features-body">
                <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">
                  Highlight key features of your product
                </p>
                <div class="items-list" id="featuresList">
                  <!-- Features will be rendered here -->
                </div>
                <button class="add-item-btn" onclick="addFeature()" style="margin-top: 12px;">
                  <i class="fas fa-plus"></i> Add Feature
                </button>
                <div class="section-actions">
                  <button class="btn btn-primary" onclick="saveFeatures()">
                    <i class="fas fa-save"></i> Save Features
                  </button>
                </div>
              </div>
            </div>

            <!-- Trust Badges Section -->
            <div class="content-section" id="badges-section">
              <div class="section-header" onclick="toggleSection('badges')">
                <h2 class="section-title">
                  <i class="fas fa-shield-halved"></i>
                  Trust Badges
                </h2>
                <i class="fas fa-chevron-down section-toggle"></i>
              </div>
              <div class="section-body" id="badges-body">
                <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">
                  Build customer confidence with trust badges
                </p>
                <div class="items-list" id="badgesList">
                  <!-- Badges will be rendered here -->
                </div>
                <button class="add-item-btn" onclick="addBadge()" style="margin-top: 12px;">
                  <i class="fas fa-plus"></i> Add Badge
                </button>
                <div class="section-actions">
                  <button class="btn btn-primary" onclick="saveBadges()">
                    <i class="fas fa-save"></i> Save Badges
                  </button>
                </div>
              </div>
            </div>

            <!-- Room Labels Section -->
            <div class="content-section" id="room-section">
              <div class="section-header" onclick="toggleSection('room')">
                <h2 class="section-title">
                  <i class="fas fa-door-open"></i>
                  Room Labels
                </h2>
                <i class="fas fa-chevron-down section-toggle"></i>
              </div>
              <div class="section-body" id="room-body">
                <p style="color: #6b7280; margin-bottom: 16px; font-size: 14px;">
                  Room options shown in the product configurator dropdown
                </p>
                <div class="tags-container" id="roomLabelsContainer">
                  <!-- Tags will be rendered here -->
                </div>
                <div style="display: flex; gap: 8px;">
                  <input type="text" class="form-input" id="newRoomLabel" placeholder="Enter room name" style="flex: 1; max-width: 300px;">
                  <button class="btn btn-primary" onclick="addRoomLabel()">
                    <i class="fas fa-plus"></i> Add
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Right Column - Preview -->
          <div class="preview-column">
            <div class="preview-card">
              <div class="preview-header">
                <span class="preview-title">
                  <i class="fas fa-eye"></i> Live Preview
                </span>
                <a href="/product/affordable-custom-roller-blinds" target="_blank" class="preview-link">
                  <i class="fas fa-external-link-alt"></i> Open
                </a>
              </div>
              <div class="preview-iframe-container">
                <iframe
                  id="previewIframe"
                  src="/product/affordable-custom-roller-blinds"
                  class="preview-iframe">
                </iframe>
              </div>
              <p class="preview-info">
                Changes are reflected after saving
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Save Banner -->
  <div class="save-banner" id="saveBanner">
    <span class="save-banner-text">
      <i class="fas fa-circle" style="font-size: 8px; color: #f59e0b;"></i>
      You have unsaved changes
    </span>
    <div class="save-banner-actions">
      <button class="btn btn-discard" onclick="discardChanges()">Discard</button>
      <button class="btn btn-save" onclick="saveAllChanges()">
        <i class="fas fa-save"></i> Save All
      </button>
    </div>
  </div>

  <!-- Hidden file input for image uploads -->
  <input type="file" id="imageUploadInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">

  <script src="js/admin.js"></script>
  <script>
    // State
    let currentProduct = null;
    let hasUnsavedChanges = false;
    let currentUploadSlot = null;

    let productData = {
      title: '',
      description: '',
      basePrice: 0,
      salePrice: null,
      images: ['', '', '', '', ''],
      features: [],
      badges: [],
      roomLabels: []
    };

    const iconOptions = [
      { value: 'fa-check', label: 'Check' },
      { value: 'fa-star', label: 'Star' },
      { value: 'fa-shield-alt', label: 'Shield' },
      { value: 'fa-truck', label: 'Truck' },
      { value: 'fa-undo', label: 'Return' },
      { value: 'fa-heart', label: 'Heart' },
      { value: 'fa-bolt', label: 'Bolt' },
      { value: 'fa-leaf', label: 'Leaf' },
      { value: 'fa-sun', label: 'Sun' },
      { value: 'fa-moon', label: 'Moon' },
      { value: 'fa-clock', label: 'Clock' },
      { value: 'fa-tools', label: 'Tools' }
    ];

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      if (!Admin.Auth.requireAuth()) return;
      await loadProducts();
      await loadProductContent();
      setupEventListeners();
    });

    // Load products list
    async function loadProducts() {
      try {
        const data = await Admin.ProductsAPI.getAll();
        const select = document.getElementById('productSelector');
        if (data.success && data.products) {
          select.innerHTML = data.products.map(p =>
            `<option value="${p.slug}">${escapeHtml(p.name)}</option>`
          ).join('');
        }
      } catch (error) {
        console.error('Failed to load products:', error);
      }
    }

    // Load content for selected product
    async function loadProductContent() {
      const slug = document.getElementById('productSelector').value;
      if (!slug) return;

      try {
        // Load product basic info
        const productRes = await fetch(`/api/products/${slug}`);
        const productJson = await productRes.json();
        if (productJson.success) {
          currentProduct = productJson.data;
          document.getElementById('productTitle').value = currentProduct.name || '';
          document.getElementById('productDescription').value = currentProduct.description || '';
          document.getElementById('productPrice').value = currentProduct.base_price || '';
          document.getElementById('productSalePrice').value = currentProduct.sale_price || '';

          // Load images
          productData.images = ['', '', '', '', ''];
          if (currentProduct.image_url) productData.images[0] = currentProduct.image_url;
          if (currentProduct.gallery_images) {
            currentProduct.gallery_images.forEach((img, i) => {
              if (i < 4) productData.images[i + 1] = img;
            });
          }
        }

        // Load page sections for features and badges
        const sectionsRes = await fetch(`/api/product-page-sections/${slug}`);
        const sectionsJson = await sectionsRes.json();
        if (sectionsJson.success && sectionsJson.sections) {
          const featuresSection = sectionsJson.sections.find(s => s.type === 'features');
          const badgesSection = sectionsJson.sections.find(s => s.type === 'trust-badges');

          productData.features = featuresSection?.data?.items || [
            { icon: 'fa-check', text: 'Energy Efficient' },
            { icon: 'fa-check', text: 'Custom Sizes' },
            { icon: 'fa-check', text: 'Easy Installation' }
          ];

          productData.badges = badgesSection?.data?.items || [
            { icon: 'fa-truck', text: 'Free Shipping' },
            { icon: 'fa-shield-alt', text: '5 Year Warranty' },
            { icon: 'fa-undo', text: 'Easy Returns' }
          ];
        } else {
          // Set defaults
          productData.features = [
            { icon: 'fa-check', text: 'Energy Efficient' },
            { icon: 'fa-check', text: 'Custom Sizes' },
            { icon: 'fa-check', text: 'Easy Installation' }
          ];
          productData.badges = [
            { icon: 'fa-truck', text: 'Free Shipping' },
            { icon: 'fa-shield-alt', text: '5 Year Warranty' },
            { icon: 'fa-undo', text: 'Easy Returns' }
          ];
        }

        // Load room labels
        try {
          const roomRes = await Admin.API.get('/product-content/room-labels');
          productData.roomLabels = roomRes.labels || ['Living Room', 'Bedroom', 'Kitchen', 'Bathroom', 'Office'];
        } catch {
          productData.roomLabels = ['Living Room', 'Bedroom', 'Kitchen', 'Bathroom', 'Office'];
        }

        renderAll();
        updatePreview();
      } catch (error) {
        console.error('Failed to load product content:', error);
        Admin.Toast.error('Failed to load product content');
      }
    }

    // Render all sections
    function renderAll() {
      renderGallery();
      renderFeatures();
      renderBadges();
      renderRoomLabels();
    }

    // Render gallery
    function renderGallery() {
      const grid = document.getElementById('galleryGrid');
      const labels = ['Main Image', 'Gallery 2', 'Gallery 3', 'Gallery 4', 'Gallery 5'];

      grid.innerHTML = productData.images.map((img, i) => `
        <div class="image-upload-card ${img ? 'has-image' : ''}" onclick="triggerImageUpload(${i})">
          <div class="image-preview">
            ${img ? `
              <img src="${img}" alt="${labels[i]}">
              <button class="remove-image-btn" onclick="event.stopPropagation(); removeImage(${i});">
                <i class="fas fa-times"></i>
              </button>
            ` : `
              <i class="fas fa-cloud-upload-alt upload-icon"></i>
            `}
          </div>
          <span class="image-label">${labels[i]}</span>
        </div>
      `).join('');
    }

    // Image upload
    function triggerImageUpload(slot) {
      currentUploadSlot = slot;
      document.getElementById('imageUploadInput').click();
    }

    async function handleImageUpload(input) {
      if (!input.files || !input.files[0]) return;

      const file = input.files[0];
      const formData = new FormData();
      formData.append('image', file);

      try {
        const response = await fetch('/api/admin/upload', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${Admin.Auth.getToken()}` },
          body: formData
        });
        const result = await response.json();
        if (result.success) {
          productData.images[currentUploadSlot] = result.url;
          renderGallery();
          markUnsaved();
          Admin.Toast.success('Image uploaded');
        }
      } catch (error) {
        Admin.Toast.error('Failed to upload image');
      }
      input.value = '';
    }

    function removeImage(slot) {
      productData.images[slot] = '';
      renderGallery();
      markUnsaved();
    }

    // Render features
    function renderFeatures() {
      const container = document.getElementById('featuresList');
      container.innerHTML = productData.features.map((feature, i) => `
        <div class="item-row">
          <i class="fas fa-grip-vertical drag-handle"></i>
          <select class="form-select icon-select" onchange="updateFeature(${i}, 'icon', this.value)">
            ${iconOptions.map(opt =>
              `<option value="${opt.value}" ${feature.icon === opt.value ? 'selected' : ''}>${opt.label}</option>`
            ).join('')}
          </select>
          <input type="text" class="form-input text-input" value="${escapeHtml(feature.text)}"
                 onchange="updateFeature(${i}, 'text', this.value)" placeholder="Feature text">
          <button class="remove-btn" onclick="removeFeature(${i})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');
    }

    function addFeature() {
      productData.features.push({ icon: 'fa-check', text: '' });
      renderFeatures();
      markUnsaved();
    }

    function updateFeature(index, key, value) {
      productData.features[index][key] = value;
      markUnsaved();
    }

    function removeFeature(index) {
      productData.features.splice(index, 1);
      renderFeatures();
      markUnsaved();
    }

    // Render badges
    function renderBadges() {
      const container = document.getElementById('badgesList');
      container.innerHTML = productData.badges.map((badge, i) => `
        <div class="item-row">
          <i class="fas fa-grip-vertical drag-handle"></i>
          <select class="form-select icon-select" onchange="updateBadge(${i}, 'icon', this.value)">
            ${iconOptions.map(opt =>
              `<option value="${opt.value}" ${badge.icon === opt.value ? 'selected' : ''}>${opt.label}</option>`
            ).join('')}
          </select>
          <input type="text" class="form-input text-input" value="${escapeHtml(badge.text)}"
                 onchange="updateBadge(${i}, 'text', this.value)" placeholder="Badge text">
          <button class="remove-btn" onclick="removeBadge(${i})">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');
    }

    function addBadge() {
      productData.badges.push({ icon: 'fa-shield-alt', text: '' });
      renderBadges();
      markUnsaved();
    }

    function updateBadge(index, key, value) {
      productData.badges[index][key] = value;
      markUnsaved();
    }

    function removeBadge(index) {
      productData.badges.splice(index, 1);
      renderBadges();
      markUnsaved();
    }

    // Render room labels
    function renderRoomLabels() {
      const container = document.getElementById('roomLabelsContainer');
      if (!productData.roomLabels.length) {
        container.innerHTML = '<span style="color: #9ca3af; font-size: 14px;">No room labels yet</span>';
        return;
      }
      container.innerHTML = productData.roomLabels.map((label, i) => `
        <span class="tag">
          ${escapeHtml(label)}
          <button class="remove-tag" onclick="removeRoomLabel(${i})">
            <i class="fas fa-times"></i>
          </button>
        </span>
      `).join('');
    }

    function addRoomLabel() {
      const input = document.getElementById('newRoomLabel');
      const label = input.value.trim();
      if (!label) return;
      if (productData.roomLabels.includes(label)) {
        Admin.Toast.warning('Label already exists');
        return;
      }
      productData.roomLabels.push(label);
      input.value = '';
      renderRoomLabels();
      saveRoomLabels();
    }

    function removeRoomLabel(index) {
      productData.roomLabels.splice(index, 1);
      renderRoomLabels();
      saveRoomLabels();
    }

    async function saveRoomLabels() {
      try {
        await Admin.API.put('/product-content/room-labels', { labels: productData.roomLabels });
        Admin.Toast.success('Room labels saved');
      } catch {
        Admin.Toast.error('Failed to save room labels');
      }
    }

    // Save functions
    async function saveProductInfo() {
      const slug = document.getElementById('productSelector').value;
      const data = {
        name: document.getElementById('productTitle').value,
        description: document.getElementById('productDescription').value,
        base_price: parseFloat(document.getElementById('productPrice').value) || 0,
        sale_price: document.getElementById('productSalePrice').value ?
          parseFloat(document.getElementById('productSalePrice').value) : null
      };

      try {
        await Admin.ProductsAPI.update(currentProduct.id, data);
        Admin.Toast.success('Product info saved');
        hideSaveBanner();
        updatePreview();
      } catch (error) {
        Admin.Toast.error('Failed to save product info');
      }
    }

    async function saveGallery() {
      const data = {
        image_url: productData.images[0] || null,
        gallery_images: productData.images.slice(1).filter(Boolean)
      };

      try {
        await Admin.ProductsAPI.update(currentProduct.id, data);
        Admin.Toast.success('Gallery saved');
        hideSaveBanner();
        updatePreview();
      } catch (error) {
        Admin.Toast.error('Failed to save gallery');
      }
    }

    async function saveFeatures() {
      const slug = document.getElementById('productSelector').value;
      await saveSections(slug);
      Admin.Toast.success('Features saved');
    }

    async function saveBadges() {
      const slug = document.getElementById('productSelector').value;
      await saveSections(slug);
      Admin.Toast.success('Badges saved');
    }

    async function saveSections(slug) {
      // Get existing sections or create new
      let sections = [];
      try {
        const res = await Admin.API.get(`/product-page-sections/${slug}`);
        if (res.success) sections = res.sections || [];
      } catch {}

      // Update or add features section
      let featuresIdx = sections.findIndex(s => s.type === 'features');
      const featuresSection = {
        id: sections[featuresIdx]?.id || 'section-features-' + Date.now(),
        type: 'features',
        name: 'Product Features',
        isVisible: true,
        data: { title: 'Features', items: productData.features }
      };
      if (featuresIdx >= 0) {
        sections[featuresIdx] = featuresSection;
      } else {
        sections.push(featuresSection);
      }

      // Update or add badges section
      let badgesIdx = sections.findIndex(s => s.type === 'trust-badges');
      const badgesSection = {
        id: sections[badgesIdx]?.id || 'section-badges-' + Date.now(),
        type: 'trust-badges',
        name: 'Trust Badges',
        isVisible: true,
        data: { items: productData.badges }
      };
      if (badgesIdx >= 0) {
        sections[badgesIdx] = badgesSection;
      } else {
        sections.push(badgesSection);
      }

      await Admin.API.put(`/product-page-sections/${slug}`, { sections });
      hideSaveBanner();
      updatePreview();
    }

    async function saveAllChanges() {
      await saveProductInfo();
      await saveGallery();
      const slug = document.getElementById('productSelector').value;
      await saveSections(slug);
      await saveRoomLabels();
      Admin.Toast.success('All changes saved');
      hideSaveBanner();
    }

    function discardChanges() {
      loadProductContent();
      hideSaveBanner();
    }

    // UI helpers
    function markUnsaved() {
      hasUnsavedChanges = true;
      document.getElementById('saveBanner').classList.add('visible');
    }

    function hideSaveBanner() {
      hasUnsavedChanges = false;
      document.getElementById('saveBanner').classList.remove('visible');
    }

    function toggleSection(section) {
      const header = document.querySelector(`#${section}-section .section-header`);
      const body = document.getElementById(`${section}-body`);
      header.classList.toggle('collapsed');
      body.classList.toggle('collapsed');
    }

    function updatePreview() {
      const iframe = document.getElementById('previewIframe');
      iframe.src = iframe.src;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function setupEventListeners() {
      // Enter key for room labels
      document.getElementById('newRoomLabel').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addRoomLabel();
        }
      });

      // Warn before leaving
      window.addEventListener('beforeunload', (e) => {
        if (hasUnsavedChanges) {
          e.preventDefault();
          e.returnValue = '';
        }
      });
    }
  </script>
</body>
</html>
