<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics & Reports - Peekaboo Shades Admin</title>
  <link rel="stylesheet" href="css/admin.css">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    @media (max-width: 1200px) { .analytics-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .analytics-grid { grid-template-columns: 1fr; } }

    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .stat-card h4 {
      font-size: 12px;
      color: #6D7175;
      margin-bottom: 8px;
      text-transform: uppercase;
    }
    .stat-card .value {
      font-size: 28px;
      font-weight: 600;
      color: #202223;
    }
    .stat-card .value.positive { color: #008060; }
    .stat-card .value.negative { color: #D72C0D; }
    .stat-card .subtext {
      font-size: 12px;
      color: #6D7175;
      margin-top: 4px;
    }

    .chart-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    .chart-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    @media (max-width: 1024px) { .chart-row, .chart-row-3 { grid-template-columns: 1fr; } }

    .analytics-card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .analytics-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .analytics-card-title {
      font-size: 16px;
      font-weight: 600;
      color: #202223;
    }
    .chart-container {
      height: 280px;
      position: relative;
    }
    .chart-container.small { height: 200px; }

    .tabs {
      display: flex;
      gap: 4px;
      border-bottom: 1px solid #E5E5E5;
      margin-bottom: 24px;
      overflow-x: auto;
    }
    .tab-btn {
      padding: 12px 20px;
      border: none;
      background: none;
      font-size: 14px;
      color: #6D7175;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      white-space: nowrap;
    }
    .tab-btn:hover { color: #202223; }
    .tab-btn.active {
      color: #8E6545;
      border-bottom-color: #8E6545;
      font-weight: 500;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    .data-table th {
      text-align: left;
      padding: 12px 8px;
      font-size: 12px;
      font-weight: 600;
      color: #6D7175;
      text-transform: uppercase;
      border-bottom: 1px solid #E5E5E5;
    }
    .data-table td {
      padding: 12px 8px;
      font-size: 14px;
      color: #202223;
      border-bottom: 1px solid #F0F0F0;
    }
    .data-table .value { text-align: right; font-weight: 600; }
    .data-table .rank { width: 40px; color: #6D7175; }

    .progress-bar {
      background: #F0F0F0;
      border-radius: 4px;
      height: 8px;
      overflow: hidden;
    }
    .progress-bar .fill {
      height: 100%;
      background: linear-gradient(90deg, #8E6545, #B38B6D);
      border-radius: 4px;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-success { background: #E3F1DF; color: #008060; }
    .badge-warning { background: #FFF3CD; color: #B98900; }
    .badge-danger { background: #FEE9E9; color: #D72C0D; }

    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 60px;
    }
    .loading-spinner::after {
      content: "";
      width: 32px;
      height: 32px;
      border: 3px solid #E5E5E5;
      border-top-color: #8E6545;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .metric-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .metric-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #F9FAFB;
      border-radius: 6px;
    }
    .metric-item .label { font-size: 14px; color: #202223; }
    .metric-item .value { font-size: 16px; font-weight: 600; color: #8E6545; }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <a href="/admin/" class="sidebar-logo">
          <img src="/images/logo.png" alt="Logo" onerror="this.style.display='none'">
          <span>Peekaboo Shades</span>
        </a>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <a href="/admin/" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            <span>Dashboard</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Sales</div>
          <a href="/admin/orders.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            <span>Orders</span>
          </a>
          <a href="/admin/invoices.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <span>Invoices</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Finance</div>
          <a href="/admin/accounts.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Accounts & Profit</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Catalog</div>
          <a href="/admin/products.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
            <span>Products</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Analytics</div>
          <a href="/admin/analytics.html" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <span>Reports</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Settings</div>
          <a href="/admin/settings.html" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span>Settings</span>
          </a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <header class="admin-header">
        <div class="header-left">
          <div class="breadcrumb">
            <a href="/admin/" class="breadcrumb-link">Dashboard</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-current">Analytics & Reports</span>
          </div>
        </div>
        <div class="header-right">
          <div class="dropdown">
            <div class="header-profile">
              <div class="profile-avatar">A</div>
              <span class="profile-name">Admin</span>
            </div>
            <div class="dropdown-menu profile-dropdown">
              <a href="/admin/settings.html" class="dropdown-item">Profile</a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item danger" onclick="Admin.AuthAPI.logout(); return false;">Logout</a>
            </div>
          </div>
        </div>
      </header>

      <!-- Page Content -->
      <div class="admin-content">
        <h1 class="page-title">Analytics & Reports</h1>

        <!-- Tabs -->
        <div class="tabs">
          <button class="tab-btn active" data-tab="products">Products</button>
          <button class="tab-btn" data-tab="customers">Customers</button>
          <button class="tab-btn" data-tab="finance">Finance</button>
          <button class="tab-btn" data-tab="traffic">Traffic & Sessions</button>
        </div>

        <!-- Products Tab -->
        <div id="tab-products" class="tab-content active">
          <div id="products-loading" class="loading-spinner"></div>
          <div id="products-content" style="display: none;">
            <!-- Blinds Type -->
            <div class="chart-row">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Blinds Type Distribution</h3>
                </div>
                <div class="chart-container">
                  <canvas id="blindsTypeChart"></canvas>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Control System Usage</h3>
                </div>
                <div class="chart-container">
                  <canvas id="controlSystemChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Measurements & Sizes -->
            <div class="chart-row">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Size Range Distribution</h3>
                </div>
                <div class="chart-container">
                  <canvas id="sizeRangeChart"></canvas>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Top 10 Popular Sizes</h3>
                </div>
                <table class="data-table" id="popularSizesTable">
                  <thead>
                    <tr>
                      <th class="rank">#</th>
                      <th>Dimensions</th>
                      <th class="value">Orders</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <!-- Light Filtering & Hardware -->
            <div class="chart-row-3">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Light Filtering</h3>
                </div>
                <div class="chart-container small">
                  <canvas id="lightFilteringChart"></canvas>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Valance Types</h3>
                </div>
                <div class="metric-list" id="valanceTypesList"></div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Motor Brands</h3>
                </div>
                <div class="metric-list" id="motorBrandsList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Customers Tab -->
        <div id="tab-customers" class="tab-content">
          <div id="customers-loading" class="loading-spinner"></div>
          <div id="customers-content" style="display: none;">
            <!-- Summary Stats -->
            <div class="analytics-grid" id="customer-stats"></div>

            <!-- Customer Types & Location -->
            <div class="chart-row">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Customer Types</h3>
                </div>
                <div class="chart-container">
                  <canvas id="customerTypesChart"></canvas>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Orders by State</h3>
                </div>
                <div class="chart-container">
                  <canvas id="ordersByStateChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Top Customers & Cities -->
            <div class="chart-row">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Top Customers by Revenue</h3>
                </div>
                <table class="data-table" id="topCustomersTable">
                  <thead>
                    <tr>
                      <th class="rank">#</th>
                      <th>Customer</th>
                      <th class="value">Orders</th>
                      <th class="value">Revenue</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Top Cities</h3>
                </div>
                <table class="data-table" id="topCitiesTable">
                  <thead>
                    <tr>
                      <th class="rank">#</th>
                      <th>City</th>
                      <th class="value">Orders</th>
                      <th class="value">Revenue</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <!-- Social Login -->
            <div class="chart-row">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Login Methods</h3>
                </div>
                <div class="chart-container small">
                  <canvas id="socialLoginChart"></canvas>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Customer Acquisition Trend</h3>
                </div>
                <div class="chart-container small">
                  <canvas id="acquisitionTrendChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Finance Tab -->
        <div id="tab-finance" class="tab-content">
          <div id="finance-loading" class="loading-spinner"></div>
          <div id="finance-content" style="display: none;">
            <!-- Summary Stats -->
            <div class="analytics-grid" id="finance-stats"></div>

            <!-- Revenue Trend -->
            <div class="analytics-card" style="margin-bottom: 24px;">
              <div class="analytics-card-header">
                <h3 class="analytics-card-title">Revenue & Profit Trend</h3>
              </div>
              <div class="chart-container">
                <canvas id="revenueTrendChart"></canvas>
              </div>
            </div>

            <!-- Revenue by Category & Payment Methods -->
            <div class="chart-row">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Revenue by Category</h3>
                </div>
                <div class="chart-container">
                  <canvas id="revenueByCategoryChart"></canvas>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Payment Methods</h3>
                </div>
                <div class="chart-container">
                  <canvas id="paymentMethodsChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Order Status & Ledger Summary -->
            <div class="chart-row">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Order Status</h3>
                </div>
                <div class="chart-container small">
                  <canvas id="orderStatusChart"></canvas>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Accounts Summary</h3>
                </div>
                <div class="metric-list" id="ledgerSummaryList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Traffic Tab -->
        <div id="tab-traffic" class="tab-content">
          <div id="traffic-loading" class="loading-spinner"></div>
          <div id="traffic-content" style="display: none;">
            <!-- Summary Stats -->
            <div class="analytics-grid" id="traffic-stats"></div>

            <!-- Traffic Sources & Geographic -->
            <div class="chart-row">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Traffic Sources</h3>
                </div>
                <div class="chart-container">
                  <canvas id="trafficSourcesChart"></canvas>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Orders by Location</h3>
                </div>
                <div class="chart-container">
                  <canvas id="geoChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Top Pages & Social Referrals -->
            <div class="chart-row">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Top Pages</h3>
                </div>
                <table class="data-table" id="topPagesTable">
                  <thead>
                    <tr>
                      <th class="rank">#</th>
                      <th>Page</th>
                      <th class="value">Views</th>
                      <th class="value">Unique</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Social Media Referrals</h3>
                </div>
                <div class="chart-container small">
                  <canvas id="socialReferralsChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Device & Browser -->
            <div class="chart-row">
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Device Types</h3>
                </div>
                <div class="chart-container small">
                  <canvas id="deviceChart"></canvas>
                </div>
              </div>
              <div class="analytics-card">
                <div class="analytics-card-header">
                  <h3 class="analytics-card-title">Session Statistics</h3>
                </div>
                <div class="metric-list" id="sessionStatsList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="js/admin.js"></script>
  <script>
    // Chart instances
    let charts = {};
    const chartColors = ['#8E6545', '#B38B6D', '#D4B896', '#2C6ECB', '#008060', '#B98900', '#D72C0D', '#6D7175'];

    // Require authentication
    if (!Admin.Auth.requireAuth()) {
      // Will redirect
    } else {
      initTabs();
      loadProductsTab();
    }

    function initTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          document.getElementById('tab-' + this.dataset.tab).classList.add('active');

          // Load tab data
          if (this.dataset.tab === 'products') loadProductsTab();
          else if (this.dataset.tab === 'customers') loadCustomersTab();
          else if (this.dataset.tab === 'finance') loadFinanceTab();
          else if (this.dataset.tab === 'traffic') loadTrafficTab();
        });
      });
    }

    // ===== PRODUCTS TAB =====
    async function loadProductsTab() {
      document.getElementById('products-loading').style.display = 'flex';
      document.getElementById('products-content').style.display = 'none';

      try {
        const response = await fetch('/api/admin/analytics/product-insights', {
          headers: { 'Authorization': `Bearer ${Admin.Auth.getToken()}` }
        });
        const data = await response.json();

        if (data.success) {
          renderProductsTab(data);
        }
      } catch (error) {
        console.error('Failed to load products analytics:', error);
      }

      document.getElementById('products-loading').style.display = 'none';
      document.getElementById('products-content').style.display = 'block';
    }

    function renderProductsTab(data) {
      // Blinds Type Chart
      if (charts.blindsType) charts.blindsType.destroy();
      const btCtx = document.getElementById('blindsTypeChart').getContext('2d');
      charts.blindsType = new Chart(btCtx, {
        type: 'doughnut',
        data: {
          labels: data.blindsType.map(b => b.name),
          datasets: [{
            data: data.blindsType.map(b => b.orders),
            backgroundColor: chartColors
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      // Control System Chart
      if (charts.controlSystem) charts.controlSystem.destroy();
      const csCtx = document.getElementById('controlSystemChart').getContext('2d');
      charts.controlSystem = new Chart(csCtx, {
        type: 'bar',
        data: {
          labels: data.controlSystem.map(c => c.name),
          datasets: [{
            label: 'Orders',
            data: data.controlSystem.map(c => c.orders),
            backgroundColor: chartColors
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      // Size Range Chart
      if (charts.sizeRange) charts.sizeRange.destroy();
      const srCtx = document.getElementById('sizeRangeChart').getContext('2d');
      charts.sizeRange = new Chart(srCtx, {
        type: 'bar',
        data: {
          labels: data.measurements.map(m => m.label),
          datasets: [{
            label: 'Orders',
            data: data.measurements.map(m => m.orders),
            backgroundColor: '#8E6545'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      // Popular Sizes Table
      const sizesBody = document.querySelector('#popularSizesTable tbody');
      sizesBody.innerHTML = data.popularSizes.map((s, i) => `
        <tr>
          <td class="rank">${i + 1}</td>
          <td>${s.width}" x ${s.height}"</td>
          <td class="value">${s.orders}</td>
        </tr>
      `).join('') || '<tr><td colspan="3" style="text-align:center;color:#6D7175;">No data</td></tr>';

      // Light Filtering Chart
      if (charts.lightFiltering) charts.lightFiltering.destroy();
      const lfCtx = document.getElementById('lightFilteringChart').getContext('2d');
      charts.lightFiltering = new Chart(lfCtx, {
        type: 'pie',
        data: {
          labels: data.lightFiltering.map(l => l.name),
          datasets: [{
            data: data.lightFiltering.map(l => l.orders),
            backgroundColor: ['#1a1a2e', '#6D7175', '#D4B896', '#B38B6D']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      // Valance Types List
      const valanceList = document.getElementById('valanceTypesList');
      valanceList.innerHTML = data.valanceTypes.slice(0, 5).map(v => `
        <div class="metric-item">
          <span class="label">${formatOptionName(v.name)}</span>
          <span class="value">${v.orders}</span>
        </div>
      `).join('') || '<div style="text-align:center;color:#6D7175;padding:20px;">No data</div>';

      // Motor Brands List
      const motorList = document.getElementById('motorBrandsList');
      motorList.innerHTML = data.motorBrands.slice(0, 5).map(m => `
        <div class="metric-item">
          <span class="label">${formatOptionName(m.name)}</span>
          <span class="value">${m.orders}</span>
        </div>
      `).join('') || '<div style="text-align:center;color:#6D7175;padding:20px;">No motorized orders</div>';
    }

    // ===== CUSTOMERS TAB =====
    async function loadCustomersTab() {
      document.getElementById('customers-loading').style.display = 'flex';
      document.getElementById('customers-content').style.display = 'none';

      try {
        const response = await fetch('/api/admin/analytics/customer-insights', {
          headers: { 'Authorization': `Bearer ${Admin.Auth.getToken()}` }
        });
        const data = await response.json();

        if (data.success) {
          renderCustomersTab(data);
        }
      } catch (error) {
        console.error('Failed to load customer analytics:', error);
      }

      document.getElementById('customers-loading').style.display = 'none';
      document.getElementById('customers-content').style.display = 'block';
    }

    function renderCustomersTab(data) {
      // Stats Grid
      document.getElementById('customer-stats').innerHTML = `
        <div class="stat-card">
          <h4>Total Customers</h4>
          <div class="value">${data.summary.totalCustomers}</div>
        </div>
        <div class="stat-card">
          <h4>New Customers</h4>
          <div class="value">${data.summary.newCustomers}</div>
          <div class="subtext">First-time buyers</div>
        </div>
        <div class="stat-card">
          <h4>Returning</h4>
          <div class="value">${data.summary.returningCustomers}</div>
          <div class="subtext">2 orders</div>
        </div>
        <div class="stat-card">
          <h4>Loyal Customers</h4>
          <div class="value positive">${data.summary.loyalCustomers}</div>
          <div class="subtext">3+ orders</div>
        </div>
      `;

      // Customer Types Chart
      if (charts.customerTypes) charts.customerTypes.destroy();
      const ctCtx = document.getElementById('customerTypesChart').getContext('2d');
      charts.customerTypes = new Chart(ctCtx, {
        type: 'doughnut',
        data: {
          labels: data.customerTypes.map(c => c.name),
          datasets: [{
            data: data.customerTypes.map(c => c.value),
            backgroundColor: ['#2C6ECB', '#B98900', '#008060']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      // Orders by State Chart
      if (charts.ordersByState) charts.ordersByState.destroy();
      const osCtx = document.getElementById('ordersByStateChart').getContext('2d');
      charts.ordersByState = new Chart(osCtx, {
        type: 'bar',
        data: {
          labels: data.topStates.map(s => s.name),
          datasets: [{
            label: 'Orders',
            data: data.topStates.map(s => s.orders),
            backgroundColor: '#8E6545'
          }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      // Top Customers Table
      const custBody = document.querySelector('#topCustomersTable tbody');
      custBody.innerHTML = data.topCustomers.map((c, i) => `
        <tr>
          <td class="rank">${i + 1}</td>
          <td>${Admin.Utils.escapeHtml(c.name || c.email)}</td>
          <td class="value">${c.orders}</td>
          <td class="value">${Admin.Utils.formatCurrency(c.revenue)}</td>
        </tr>
      `).join('') || '<tr><td colspan="4" style="text-align:center;color:#6D7175;">No data</td></tr>';

      // Top Cities Table
      const citiesBody = document.querySelector('#topCitiesTable tbody');
      citiesBody.innerHTML = data.topCities.map((c, i) => `
        <tr>
          <td class="rank">${i + 1}</td>
          <td>${Admin.Utils.escapeHtml(c.name)}</td>
          <td class="value">${c.orders}</td>
          <td class="value">${Admin.Utils.formatCurrency(c.revenue)}</td>
        </tr>
      `).join('') || '<tr><td colspan="4" style="text-align:center;color:#6D7175;">No data</td></tr>';

      // Social Login Chart
      if (charts.socialLogin) charts.socialLogin.destroy();
      const slCtx = document.getElementById('socialLoginChart').getContext('2d');
      charts.socialLogin = new Chart(slCtx, {
        type: 'pie',
        data: {
          labels: data.socialLogin.map(s => s.name),
          datasets: [{
            data: data.socialLogin.map(s => s.count),
            backgroundColor: ['#6D7175', '#DB4437', '#4267B2', '#000000']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      // Acquisition Trend Chart
      if (charts.acquisitionTrend) charts.acquisitionTrend.destroy();
      const atCtx = document.getElementById('acquisitionTrendChart').getContext('2d');
      charts.acquisitionTrend = new Chart(atCtx, {
        type: 'line',
        data: {
          labels: data.acquisitionTrend.slice(-14).map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
          datasets: [{
            label: 'New Customers',
            data: data.acquisitionTrend.slice(-14).map(d => d.newCustomers),
            borderColor: '#008060',
            backgroundColor: 'rgba(0, 128, 96, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
    }

    // ===== FINANCE TAB =====
    async function loadFinanceTab() {
      document.getElementById('finance-loading').style.display = 'flex';
      document.getElementById('finance-content').style.display = 'none';

      try {
        const response = await fetch('/api/admin/analytics/finance-insights', {
          headers: { 'Authorization': `Bearer ${Admin.Auth.getToken()}` }
        });
        const data = await response.json();

        if (data.success) {
          renderFinanceTab(data);
        }
      } catch (error) {
        console.error('Failed to load finance analytics:', error);
      }

      document.getElementById('finance-loading').style.display = 'none';
      document.getElementById('finance-content').style.display = 'block';
    }

    function renderFinanceTab(data) {
      // Stats Grid
      document.getElementById('finance-stats').innerHTML = `
        <div class="stat-card">
          <h4>Total Revenue</h4>
          <div class="value">${Admin.Utils.formatCurrency(data.summary.totalRevenue)}</div>
        </div>
        <div class="stat-card">
          <h4>Gross Profit</h4>
          <div class="value positive">${Admin.Utils.formatCurrency(data.summary.grossProfit)}</div>
          <div class="subtext">${data.summary.profitMargin}% margin</div>
        </div>
        <div class="stat-card">
          <h4>Manufacturer Cost</h4>
          <div class="value negative">${Admin.Utils.formatCurrency(data.summary.totalMfrCost)}</div>
        </div>
        <div class="stat-card">
          <h4>Avg Order Value</h4>
          <div class="value">${Admin.Utils.formatCurrency(data.summary.avgOrderValue)}</div>
          <div class="subtext">${data.summary.totalOrders} orders</div>
        </div>
      `;

      // Revenue Trend Chart
      if (charts.revenueTrend) charts.revenueTrend.destroy();
      const rtCtx = document.getElementById('revenueTrendChart').getContext('2d');
      charts.revenueTrend = new Chart(rtCtx, {
        type: 'line',
        data: {
          labels: data.revenueByDate.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
          datasets: [
            {
              label: 'Revenue',
              data: data.revenueByDate.map(d => d.revenue),
              borderColor: '#8E6545',
              backgroundColor: 'rgba(142, 101, 69, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Profit',
              data: data.revenueByDate.map(d => d.profit),
              borderColor: '#008060',
              backgroundColor: 'transparent',
              borderDash: [5, 5],
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + v } } }
        }
      });

      // Revenue by Category Chart
      if (charts.revenueByCategory) charts.revenueByCategory.destroy();
      const rcCtx = document.getElementById('revenueByCategoryChart').getContext('2d');
      charts.revenueByCategory = new Chart(rcCtx, {
        type: 'bar',
        data: {
          labels: data.revenueByCategory.map(c => formatOptionName(c.name)),
          datasets: [{
            label: 'Revenue',
            data: data.revenueByCategory.map(c => c.revenue),
            backgroundColor: chartColors
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: v => '$' + v } } } }
      });

      // Payment Methods Chart
      if (charts.paymentMethods) charts.paymentMethods.destroy();
      const pmCtx = document.getElementById('paymentMethodsChart').getContext('2d');
      charts.paymentMethods = new Chart(pmCtx, {
        type: 'doughnut',
        data: {
          labels: data.paymentMethods.map(p => formatOptionName(p.name)),
          datasets: [{
            data: data.paymentMethods.map(p => p.count),
            backgroundColor: chartColors
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      // Order Status Chart
      if (charts.orderStatus) charts.orderStatus.destroy();
      const osCtx = document.getElementById('orderStatusChart').getContext('2d');
      charts.orderStatus = new Chart(osCtx, {
        type: 'pie',
        data: {
          labels: data.orderStatus.map(s => formatOptionName(s.name)),
          datasets: [{
            data: data.orderStatus.map(s => s.count),
            backgroundColor: ['#008060', '#B98900', '#2C6ECB', '#D72C0D', '#6D7175']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      // Ledger Summary
      const ledgerList = document.getElementById('ledgerSummaryList');
      ledgerList.innerHTML = `
        <div class="metric-item">
          <span class="label">Payments Received</span>
          <span class="value" style="color:#008060;">${Admin.Utils.formatCurrency(data.ledgerSummary.paymentsReceived)}</span>
        </div>
        <div class="metric-item">
          <span class="label">Payable to Manufacturer</span>
          <span class="value" style="color:#D72C0D;">${Admin.Utils.formatCurrency(data.ledgerSummary.payableToManufacturer)}</span>
        </div>
        <div class="metric-item">
          <span class="label">Paid to Manufacturer</span>
          <span class="value">${Admin.Utils.formatCurrency(data.ledgerSummary.paidToManufacturer)}</span>
        </div>
        <div class="metric-item">
          <span class="label">Outstanding Payable</span>
          <span class="value" style="color:#B98900;">${Admin.Utils.formatCurrency(data.ledgerSummary.outstandingPayable)}</span>
        </div>
      `;
    }

    // ===== TRAFFIC TAB =====
    async function loadTrafficTab() {
      document.getElementById('traffic-loading').style.display = 'flex';
      document.getElementById('traffic-content').style.display = 'none';

      try {
        const response = await fetch('/api/admin/analytics/traffic-insights', {
          headers: { 'Authorization': `Bearer ${Admin.Auth.getToken()}` }
        });
        const data = await response.json();

        if (data.success) {
          renderTrafficTab(data);
        }
      } catch (error) {
        console.error('Failed to load traffic analytics:', error);
      }

      document.getElementById('traffic-loading').style.display = 'none';
      document.getElementById('traffic-content').style.display = 'block';
    }

    function renderTrafficTab(data) {
      // Stats Grid
      document.getElementById('traffic-stats').innerHTML = `
        <div class="stat-card">
          <h4>Page Views</h4>
          <div class="value">${data.summary.totalPageViews}</div>
        </div>
        <div class="stat-card">
          <h4>Unique Sessions</h4>
          <div class="value">${data.summary.uniqueSessions}</div>
        </div>
        <div class="stat-card">
          <h4>Active Sessions</h4>
          <div class="value positive">${data.summary.activeSessions}</div>
          <div class="subtext">Last 15 min</div>
        </div>
        <div class="stat-card">
          <h4>Avg Session Duration</h4>
          <div class="value">${data.summary.avgSessionDurationFormatted}</div>
        </div>
      `;

      // Traffic Sources Chart
      if (charts.trafficSources) charts.trafficSources.destroy();
      const tsCtx = document.getElementById('trafficSourcesChart').getContext('2d');
      charts.trafficSources = new Chart(tsCtx, {
        type: 'doughnut',
        data: {
          labels: data.trafficSources.map(s => formatOptionName(s.name)),
          datasets: [{
            data: data.trafficSources.map(s => s.visits),
            backgroundColor: chartColors
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      // Geographic Chart
      if (charts.geo) charts.geo.destroy();
      const geoCtx = document.getElementById('geoChart').getContext('2d');
      charts.geo = new Chart(geoCtx, {
        type: 'bar',
        data: {
          labels: data.geographic.topStates.map(s => s.name),
          datasets: [{
            label: 'Orders',
            data: data.geographic.topStates.map(s => s.orders),
            backgroundColor: '#8E6545'
          }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      // Top Pages Table
      const pagesBody = document.querySelector('#topPagesTable tbody');
      pagesBody.innerHTML = data.topPages.slice(0, 10).map((p, i) => `
        <tr>
          <td class="rank">${i + 1}</td>
          <td>${Admin.Utils.escapeHtml(p.page)}</td>
          <td class="value">${p.views}</td>
          <td class="value">${p.uniqueVisitors}</td>
        </tr>
      `).join('') || '<tr><td colspan="4" style="text-align:center;color:#6D7175;">No page view data yet</td></tr>';

      // Social Referrals Chart
      if (charts.socialReferrals) charts.socialReferrals.destroy();
      const srCtx = document.getElementById('socialReferralsChart').getContext('2d');
      const socialData = data.socialReferrals.length > 0 ? data.socialReferrals : [{ name: 'No Data', visits: 1 }];
      charts.socialReferrals = new Chart(srCtx, {
        type: 'bar',
        data: {
          labels: socialData.map(s => s.name),
          datasets: [{
            label: 'Visits',
            data: socialData.map(s => s.visits),
            backgroundColor: ['#4267B2', '#E1306C', '#E60023', '#1DA1F2', '#000000', '#FF0000']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      // Device Chart
      if (charts.device) charts.device.destroy();
      const dCtx = document.getElementById('deviceChart').getContext('2d');
      const deviceData = data.devices.filter(d => d.count > 0);
      if (deviceData.length > 0) {
        charts.device = new Chart(dCtx, {
          type: 'pie',
          data: {
            labels: deviceData.map(d => formatOptionName(d.name)),
            datasets: [{
              data: deviceData.map(d => d.count),
              backgroundColor: ['#2C6ECB', '#008060', '#B98900']
            }]
          },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
      } else {
        dCtx.font = '14px Montserrat';
        dCtx.fillStyle = '#6D7175';
        dCtx.textAlign = 'center';
        dCtx.fillText('No device data yet', dCtx.canvas.width / 2, dCtx.canvas.height / 2);
      }

      // Session Stats List
      const sessionList = document.getElementById('sessionStatsList');
      sessionList.innerHTML = `
        <div class="metric-item">
          <span class="label">Total Sessions</span>
          <span class="value">${data.summary.uniqueSessions}</span>
        </div>
        <div class="metric-item">
          <span class="label">Currently Active</span>
          <span class="value" style="color:#008060;">${data.summary.activeSessions}</span>
        </div>
        <div class="metric-item">
          <span class="label">Avg Duration</span>
          <span class="value">${data.summary.avgSessionDurationFormatted}</span>
        </div>
        <div class="metric-item">
          <span class="label">Total Page Views</span>
          <span class="value">${data.summary.totalPageViews}</span>
        </div>
      `;
    }

    // Utility function to format option names
    function formatOptionName(name) {
      if (!name) return 'Unknown';
      return name
        .replace(/-/g, ' ')
        .replace(/_/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }
  </script>
</body>
</html>
