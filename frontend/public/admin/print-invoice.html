<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice - Peekaboo Shades</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --brand-primary: #8E6545;
      --brand-light: #F8F6F3;
      --brand-dark: #6B4D35;
      --text-primary: #333333;
      --text-secondary: #666666;
      --text-muted: #999999;
      --border-light: #E8E8E8;
      --success: #059669;
      --warning: #d97706;
      --danger: #dc2626;
      --white: #ffffff;
      --bg-cream: #FAFAFA;
    }

    body {
      font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-primary);
      background: var(--white);
      padding: 40px;
      -webkit-font-smoothing: antialiased;
    }

    .invoice-container {
      max-width: 800px;
      margin: 0 auto;
      background: var(--white);
    }

    /* ==================== HEADER ==================== */
    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 2px solid var(--brand-primary);
    }

    .company-branding {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .logo-container {
      display: flex;
      align-items: center;
    }

    .logo-img {
      height: 55px;
      width: auto;
    }

    .company-details {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.8;
      margin-top: 8px;
    }

    .company-details .address {
      font-weight: 500;
      color: var(--text-primary);
    }

    .company-details a {
      color: var(--brand-primary);
      text-decoration: none;
      font-weight: 500;
    }

    .invoice-meta {
      text-align: right;
    }

    .invoice-label {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: 2px;
      color: var(--brand-primary);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .invoice-number {
      font-size: 14px;
      font-family: 'Courier New', monospace;
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 12px;
      background: var(--brand-light);
      padding: 6px 12px;
      border-radius: 4px;
      display: inline-block;
    }

    .invoice-dates {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 2;
    }

    .invoice-dates strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .status-badge {
      display: inline-block;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 12px;
    }

    .status-paid { background: #d1fae5; color: #065f46; }
    .status-sent { background: #dbeafe; color: #1e40af; }
    .status-draft { background: #f3f4f6; color: #6b7280; }
    .status-overdue { background: #fee2e2; color: #991b1b; }
    .status-partially_paid { background: #fef3c7; color: #92400e; }

    /* ==================== INFO SECTION ==================== */
    .info-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-bottom: 35px;
      padding: 25px;
      background: var(--brand-light);
      border-radius: 8px;
    }

    .info-box-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--brand-primary);
      margin-bottom: 10px;
    }

    .info-box-content {
      color: var(--text-secondary);
      font-size: 12px;
      line-height: 1.8;
    }

    .info-box-content strong {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .order-reference {
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px dashed var(--border-light);
    }

    .order-reference .ref-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .order-reference .ref-value {
      font-family: 'Courier New', monospace;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* ==================== ITEMS TABLE ==================== */
    .items-section {
      margin-bottom: 30px;
    }

    .items-table {
      width: 100%;
      border-collapse: collapse;
    }

    .items-table thead {
      background: var(--brand-primary);
    }

    .items-table th {
      color: var(--white);
      padding: 14px 16px;
      text-align: left;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .items-table th:last-child {
      text-align: right;
    }

    .items-table th.center {
      text-align: center;
    }

    .items-table td {
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
      vertical-align: top;
      font-size: 12px;
    }

    .items-table td:last-child {
      text-align: right;
      font-weight: 600;
      font-family: 'Courier New', monospace;
    }

    .items-table td.center {
      text-align: center;
    }

    .items-table tbody tr:last-child td {
      border-bottom: none;
    }

    .item-name {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      font-size: 13px;
    }

    .item-dimensions {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .item-config {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .config-tag {
      display: inline-block;
      background: var(--brand-light);
      color: var(--brand-dark);
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .unit-price {
      font-family: 'Courier New', monospace;
      color: var(--text-secondary);
    }

    /* ==================== TOTALS SECTION ==================== */
    .totals-section {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 35px;
    }

    .totals-box {
      width: 320px;
      background: var(--brand-light);
      border-radius: 8px;
      padding: 20px 24px;
      border: 1px solid var(--border-light);
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      font-size: 12px;
      border-bottom: 1px solid var(--border-light);
    }

    .totals-row:last-child {
      border-bottom: none;
    }

    .totals-row .label {
      color: var(--text-secondary);
      font-weight: 500;
    }

    .totals-row .value {
      font-family: 'Courier New', monospace;
      font-weight: 600;
      color: var(--text-primary);
    }

    .totals-row.subtotal .label {
      font-weight: 600;
      color: var(--text-primary);
    }

    .totals-row.tax .tax-state {
      font-size: 9px;
      font-weight: 700;
      color: var(--brand-primary);
      margin-left: 4px;
    }

    .totals-row.total {
      margin-top: 8px;
      padding-top: 14px;
      border-top: 2px solid var(--brand-primary);
      border-bottom: none;
    }

    .totals-row.total .label {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .totals-row.total .value {
      font-size: 18px;
      font-weight: 700;
      color: var(--brand-primary);
    }

    .totals-row.amount-paid .value {
      color: var(--success);
    }

    .totals-row.amount-due .label {
      font-weight: 600;
    }

    .totals-row.amount-due .value {
      font-weight: 700;
      color: var(--danger);
    }

    .totals-row.amount-due.paid .value {
      color: var(--success);
    }

    .totals-row.discount .value {
      color: var(--success);
    }

    /* ==================== PAYMENT HISTORY ==================== */
    .payment-history {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--brand-primary);
      margin-bottom: 12px;
    }

    .payment-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: var(--brand-light);
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .payment-row .payment-info {
      color: var(--text-secondary);
    }

    .payment-row .payment-date {
      font-weight: 500;
      color: var(--text-primary);
    }

    /* ==================== NOTES SECTION ==================== */
    .notes-section {
      background: var(--brand-light);
      padding: 18px 22px;
      border-radius: 6px;
      margin-bottom: 30px;
      border-left: 4px solid var(--brand-primary);
    }

    .notes-section h4 {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .notes-section p {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    /* ==================== FOOTER ==================== */
    .invoice-footer {
      margin-top: 40px;
      padding-top: 25px;
      border-top: 1px solid var(--border-light);
      text-align: center;
    }

    .footer-message {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .footer-contact {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    .footer-contact a {
      color: var(--brand-primary);
      text-decoration: none;
      font-weight: 600;
    }

    .footer-brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding-top: 20px;
      border-top: 1px dashed var(--border-light);
    }

    .footer-brand-img {
      height: 30px;
      width: auto;
      opacity: 0.6;
    }

    /* ==================== UTILITIES ==================== */
    .loading {
      text-align: center;
      padding: 80px 40px;
      color: var(--text-muted);
    }

    .loading::before {
      content: '';
      display: block;
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-light);
      border-top-color: var(--brand-primary);
      border-radius: 50%;
      margin: 0 auto 20px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      text-align: center;
      padding: 80px 40px;
      color: var(--danger);
    }

    /* ==================== PRINT ACTIONS ==================== */
    .print-actions {
      position: fixed;
      top: 24px;
      right: 24px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: inherit;
    }

    .btn-primary {
      background: var(--brand-primary);
      color: var(--white);
    }

    .btn-primary:hover {
      background: var(--brand-dark);
    }

    .btn-secondary {
      background: var(--white);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-secondary:hover {
      background: var(--brand-light);
      border-color: var(--brand-primary);
    }

    /* ==================== PRINT STYLES ==================== */
    @media print {
      body {
        padding: 0;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .no-print {
        display: none !important;
      }

      .invoice-container {
        max-width: 100%;
      }

      .items-table thead {
        background: var(--brand-primary) !important;
        -webkit-print-color-adjust: exact;
      }

      .items-table th {
        color: white !important;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 20px;
      }

      .invoice-header {
        flex-direction: column;
        gap: 20px;
      }

      .invoice-meta {
        text-align: left;
      }

      .info-section {
        grid-template-columns: 1fr;
        gap: 24px;
      }

      .print-actions {
        position: relative;
        top: 0;
        right: 0;
        margin-bottom: 20px;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="print-actions no-print">
    <button class="btn btn-secondary" onclick="window.history.back()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back
    </button>
    <button class="btn btn-primary" onclick="window.print()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
        <rect x="6" y="14" width="12" height="8"/>
      </svg>
      Print Invoice
    </button>
  </div>

  <div class="invoice-container" id="invoice-content">
    <div class="loading">Loading invoice...</div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const invoiceId = urlParams.get('id') || window.location.pathname.split('/').pop();

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function parseConfig(cfg) {
      if (!cfg) return {};
      if (typeof cfg === 'object') return cfg;
      try { return JSON.parse(cfg); } catch (e) { return {}; }
    }

    function getStatusClass(status) {
      return 'status-' + (status || 'draft');
    }

    function formatStatus(status) {
      const map = {
        'draft': 'Draft',
        'sent': 'Sent',
        'paid': 'Paid',
        'partially_paid': 'Partial',
        'overdue': 'Overdue',
        'cancelled': 'Cancelled',
        'refunded': 'Refunded'
      };
      return map[status] || status;
    }

    function capitalizeFirst(str) {
      if (!str) return '';
      return str.charAt(0).toUpperCase() + str.slice(1).replace(/-/g, ' ');
    }

    async function loadInvoice() {
      const container = document.getElementById('invoice-content');

      try {
        const response = await fetch('/api/invoices/' + invoiceId + '/print');
        const data = await response.json();

        if (!data.success || !data.data) {
          container.innerHTML = '<div class="error">Invoice not found</div>';
          return;
        }

        const inv = data.data;
        const isCustomer = inv.type === 'customer';

        // Build items HTML - CUSTOMER PRICES ONLY (no manufacturer costs)
        let itemsHtml = '';
        (inv.items || []).forEach((item, idx) => {
          const cfg = parseConfig(item.configuration);
          const configTags = [];

          // Build configuration tags for display
          if (cfg.lightFiltering) configTags.push(capitalizeFirst(cfg.lightFiltering));
          if (cfg.fabricCode) configTags.push('Fabric: ' + cfg.fabricCode);
          if (cfg.controlType) configTags.push(capitalizeFirst(cfg.controlType));
          if (cfg.motorBrand) configTags.push(capitalizeFirst(cfg.motorBrand) + ' Motor');
          if (cfg.mountType) configTags.push(capitalizeFirst(cfg.mountType) + ' Mount');

          itemsHtml += `
            <tr>
              <td>${idx + 1}</td>
              <td>
                <div class="item-name">${escapeHtml(item.roomLabel || item.description || 'Custom Roller Blind')}</div>
                <div class="item-dimensions">${item.width || '-'}" W Ã— ${item.height || '-'}" H</div>
                <div class="item-config">${configTags.map(t => '<span class="config-tag">' + escapeHtml(t) + '</span>').join('')}</div>
              </td>
              <td class="center">${item.quantity || 1}</td>
              <td class="unit-price">${formatCurrency(item.unitPrice)}</td>
              <td>${formatCurrency(item.lineTotal)}</td>
            </tr>
          `;
        });

        // Build payment history HTML
        let paymentsHtml = '';
        if (inv.payments && inv.payments.length > 0) {
          paymentsHtml = `
            <div class="payment-history">
              <h3 class="section-title">Payment History</h3>
              ${inv.payments.map(p => `
                <div class="payment-row">
                  <span class="payment-info">${formatCurrency(p.amount)} via ${capitalizeFirst(p.method || 'Other')}${p.reference ? ' - Ref: ' + escapeHtml(p.reference) : ''}</span>
                  <span class="payment-date">${formatDate(p.recordedAt)}</span>
                </div>
              `).join('')}
            </div>
          `;
        }

        // Tax display
        const taxRate = inv.taxRate || 0;
        const taxPercent = (taxRate * 100).toFixed(2);
        const taxState = inv.taxState || '';

        container.innerHTML = `
          <div class="invoice-header">
            <div class="company-branding">
              <div class="logo-container">
                <img src="/images/peekabooshades_logo.jpeg" alt="Peekaboo Shades" class="logo-img">
              </div>
              <div class="company-details">
                <div class="address">2109 Valancia Dr<br>Little Elm, TX 75068</div>
                <div><a href="https://www.peekabooshades.com">www.peekabooshades.com</a></div>
                <div>support@peekabooshades.com</div>
              </div>
            </div>

            <div class="invoice-meta">
              <div class="invoice-label">Invoice</div>
              <div class="invoice-number">${escapeHtml(inv.invoiceNumber)}</div>
              <div class="invoice-dates">
                <div>Issued: <strong>${formatDate(inv.issueDate)}</strong></div>
                <div>Due: <strong>${formatDate(inv.dueDate)}</strong></div>
              </div>
              <span class="status-badge ${getStatusClass(inv.status)}">${formatStatus(inv.status)}</span>
            </div>
          </div>

          <div class="info-section">
            <div class="info-box">
              <div class="info-box-label">${isCustomer ? 'Bill To' : 'Vendor'}</div>
              <div class="info-box-content">
                ${isCustomer ? `
                  <strong>${escapeHtml(inv.customer?.name || '-')}</strong>
                  ${inv.customer?.email ? escapeHtml(inv.customer.email) + '<br>' : ''}
                  ${inv.customer?.phone ? escapeHtml(inv.customer.phone) + '<br>' : ''}
                  ${escapeHtml(inv.customer?.address || inv.billingAddress || '')}
                ` : `
                  <strong>${escapeHtml(inv.manufacturer?.name || '-')}</strong>
                  ${inv.manufacturer?.email ? escapeHtml(inv.manufacturer.email) : ''}
                `}
              </div>
            </div>

            <div class="info-box">
              <div class="info-box-label">Ship To</div>
              <div class="info-box-content">
                ${escapeHtml(inv.shippingAddress || inv.customer?.address || '-')}
              </div>
              <div class="order-reference">
                <div class="ref-label">Order Reference</div>
                <div class="ref-value">${escapeHtml(inv.orderNumber || '-')}</div>
              </div>
            </div>
          </div>

          <div class="items-section">
            <table class="items-table">
              <thead>
                <tr>
                  <th style="width: 40px;">#</th>
                  <th>Description</th>
                  <th class="center" style="width: 60px;">Qty</th>
                  <th style="width: 100px;">Unit Price</th>
                  <th style="width: 110px;">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${itemsHtml}
              </tbody>
            </table>
          </div>

          <div class="totals-section">
            <div class="totals-box">
              <div class="totals-row subtotal">
                <span class="label">Subtotal</span>
                <span class="value">${formatCurrency(inv.subtotal)}</span>
              </div>
              ${inv.tax > 0 || inv.taxState ? `
                <div class="totals-row tax">
                  <span class="label">Sales Tax${taxState ? '<span class="tax-state">(' + taxState + ')</span>' : ''} @ ${taxPercent}%</span>
                  <span class="value">${formatCurrency(inv.tax)}</span>
                </div>
              ` : ''}
              ${inv.shipping > 0 ? `
                <div class="totals-row">
                  <span class="label">Shipping</span>
                  <span class="value">${formatCurrency(inv.shipping)}</span>
                </div>
              ` : ''}
              ${inv.discount > 0 ? `
                <div class="totals-row discount">
                  <span class="label">Discount</span>
                  <span class="value">-${formatCurrency(inv.discount)}</span>
                </div>
              ` : ''}
              <div class="totals-row total">
                <span class="label">Total</span>
                <span class="value">${formatCurrency(inv.total)}</span>
              </div>
              ${inv.amountPaid > 0 ? `
                <div class="totals-row amount-paid">
                  <span class="label">Amount Paid</span>
                  <span class="value">${formatCurrency(inv.amountPaid)}</span>
                </div>
              ` : ''}
              <div class="totals-row amount-due ${inv.amountDue <= 0 ? 'paid' : ''}">
                <span class="label">Balance Due</span>
                <span class="value">${formatCurrency(inv.amountDue)}</span>
              </div>
            </div>
          </div>

          ${paymentsHtml}

          ${inv.notes ? `
            <div class="notes-section">
              <h4>Notes</h4>
              <p>${escapeHtml(inv.notes)}</p>
            </div>
          ` : ''}

          <div class="invoice-footer">
            <div class="footer-message">Thank you for choosing Peekaboo Shades!</div>
            <div class="footer-contact">
              Questions about this invoice? Contact us at
              <a href="mailto:support@peekabooshades.com">support@peekabooshades.com</a>
            </div>
            <div class="footer-brand">
              <img src="/images/peekabooshades_logo.jpeg" alt="Peekaboo Shades" class="footer-brand-img">
            </div>
          </div>
        `;

        document.title = 'Invoice ' + inv.invoiceNumber + ' - Peekaboo Shades';

      } catch (error) {
        console.error('Error loading invoice:', error);
        container.innerHTML = '<div class="error">Error loading invoice: ' + error.message + '</div>';
      }
    }

    loadInvoice();
  </script>
</body>
</html>